<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>How Iaso is deployed on AWS - IASO</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How Iaso is deployed on AWS";
        var mkdocs_page_input_path = "AWS-Deployment.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html">
          <img src="assets/iaso.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Users</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="pages/users/reference/iaso_concepts/iaso_concepts.html">Concepts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="pages/users/reference/iaso_modules/iaso_modules.html">Modules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="pages/users/reference/iaso_web/user_guide.html">Web Platform</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="pages/users/reference/iaso_mobile/iaso_mobile.html">Mobile Application</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">References</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/reference/data_model_glossary/data_model_glossary.html">Data model glossary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/reference/sql_dashboard/SQL_Dashboard_feature.html">SQL Dashboard feature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/reference/docker/docker.html">Docker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/reference/background_tasks/background_tasks.html">Background tasks & worker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/reference/env_variables/env_variables.html">Environnement variables</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="pages/dev/reference/API/entity.html">API reference: Entity</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">How to</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/how_to/contribute/contribute.html">Contribute</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/how_to/setup_dev_env/setup_dev_env.html">Setup a dev environment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="pages/dev/how_to/use_iaso_apis/use_iaso_apis.html">Use iaso apis</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">More about Iaso</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://www.openiaso.com/">Get a demo</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://www.bluesquarehub.com/">Bluesquare</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">IASO</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>How Iaso is deployed on AWS</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/BLSQ/iaso/edit/main/docs/AWS-Deployment.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-iaso-is-deployed-on-aws">How Iaso is deployed on AWS<a class="headerlink" href="#how-iaso-is-deployed-on-aws" title="Permanent link">#</a></h1>
<p>on ElasticBeanstalk + RDS
<img alt="schema archi iaso.svg" src="schema%20archi%20iaso.svg" /></p>
<hr />
<h2 id="main-parts">Main parts<a class="headerlink" href="#main-parts" title="Permanent link">#</a></h2>
<ul>
<li>Creation of the HOST environment where the Iaso code will be deployed as well as the related services</li>
<li>The deployment of the code itself and of new version</li>
</ul>
<hr />
<h2 id="host-infrastructure">Host infrastructure<a class="headerlink" href="#host-infrastructure" title="Permanent link">#</a></h2>
<p>This documentation concerned the main Iaso deployment, that are done on AWS.</p>
<p>The main pillar is <em>AWS  Elastic beanstalk</em></p>
<p>Which is kind of a magic solution from Amazon that tie several of their service together, handle deployment logic, etc...</p>
<p>In the past we configured it by hands but now we are moving toward having it  all handled via Terrraform so it is in code (we can have an history, avoid misclick, do complex ops etc...).</p>
<p>The technical term for this is "Provisioning" if you want to look it up.</p>
<h2 id="setup-of-the-elastic-beainstalk">Setup of the Elastic Beainstalk<a class="headerlink" href="#setup-of-the-elastic-beainstalk" title="Permanent link">#</a></h2>
<p>See<br />
https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create-deploy-python-django.html</p>
<p>We have custom commands and configuration in <a href=".ebextensions/">.ebextensions/</a> and in 
and in <a href=".platform/">.platform/</a> to extend the nginx config.</p>
<h2 id="running-django-3-on-elastic-beanstalk-custom-ami">Running Django 3 on Elastic Beanstalk / Custom AMI<a class="headerlink" href="#running-django-3-on-elastic-beanstalk-custom-ami" title="Permanent link">#</a></h2>
<p>Django 3 requires version 2+ of the gdal library. Sadly, Beanstalk is
based on Amazon Linux that contain an outdated version of GDAL.</p>
<p>To fix this you have to create  a custom AMI to use in your Elastic Beanstalk
environments and compile and your own version of gdal and it's dependencies.</p>
<p>See the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.customenv.html">AWS documentation on creating adn using a custom AMI</a>
and the <a href="https://docs.djangoproject.com/en/4.1/ref/contrib/gis/install/">Django documentation on compiling the GIS libraries</a></p>
<p>Custom build of the following libraries were done:</p>
<ul>
<li>geos</li>
<li>SQLite</li>
<li>proj</li>
<li>proj-data</li>
<li>spatialite</li>
<li>gdal</li>
</ul>
<p>You can check <code>scripts/create_ami.sh</code> for reference</p>
<p>Read <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.customenv.html">AWS documentation on creating adn using a custom AMI</a>
but in summary:</p>
<ol>
<li>In EC2 -&gt; AMIs, identify the AMI of the Elastic Beanstalk EC2 server(Ex: Choose a public AMI in which python3.9 installed with Amazon Linux 2).</li>
<li>Select the AMI and launch a new instance based on it. </li>
<li>Specify the instance name and choose a key pair.</li>
<li>Don't forget to set in the advanced section:</li>
</ol>
<pre><code class="language-yaml">#cloud-config
  repo_releasever: repository version number
  repo_upgrade: none
</code></pre>
<ol>
<li>Connect via SSH to the instance</li>
<li>Install the dependencies (see scripts/create_ami.sh)</li>
<li>Then go to Actions -&gt; Image -&gt; Create Image</li>
<li>When it's ready, go to the Beanstalk Instance Settings and specify the AMI reference of the image we just created.</li>
</ol>
<hr />
<h2 id="where-is-the-code">Where is the code ?<a class="headerlink" href="#where-is-the-code" title="Permanent link">#</a></h2>
<p>Infrastructure and configuration in the Github repository
<a href="https://github.com/BLSQ/terraform-iaso-eb">BLSQ/terraform-iaso-eb</a> There is good documentation from Mbayang in the <code>docs/</code> folder. Visibility is restricted.</p>
<p>In the <code>BLSQ/iaso</code> Github repository:
* <code>.github</code> For the workflow info
* <code>scripts/</code>
* <code>.ebextension</code> For the Elastic beanstalk specific command
* <code>.platform</code> Configuration override</p>
<hr />
<h2 id="related-services">Related services<a class="headerlink" href="#related-services" title="Permanent link">#</a></h2>
<ul>
<li>S3 bucket: For the static and the user uploaded media (in AWS)</li>
<li>Enketo (in another AWS Elastic Beanstalk)</li>
<li>Postgresql RDS (in AWS)</li>
<li>Queue Service for background Worker  (in AWS SQS)</li>
<li>Sentry: error handling and notification (as Saas)</li>
<li>MailGun (as Saas)</li>
<li>Route53: DNS redirection (in AWS)</li>
</ul>
<hr />
<p>Two type of env in elastic beanstalk:
* web
* worker</p>
<p>We tie them via an "env" tag in AWS, so we can deploy them at the same time</p>
<p>One Elastic Beanstalk Env can contain multipe "EC2 Instance", that is virtual machine server.  Their number auto scale according to rule in elastic beanstalk.
Usually we have 1 instance for Worker and 2 for Web.</p>
<hr />
<h1 id="s3-bucket">S3 bucket<a class="headerlink" href="#s3-bucket" title="Permanent link">#</a></h1>
<ul>
<li>Static: Push static in them so they can be properly cached and CDN (not sure we actually do this)</li>
<li>Media: Store uploaded media by the users : Form response (XML), media attached to Form response (photos), gpkg, form definition, etc.. </li>
</ul>
<p>Static are readable by all.</p>
<p>Media are only accessible via Signed url that expire after a laps of time (15 minutes I think) and that are generated on the fly by iaso when needed.</p>
<hr />
<h1 id="cicd">CI/CD<a class="headerlink" href="#cicd" title="Permanent link">#</a></h1>
<p>Deployment of new version is done via Github action.</p>
<p>Each change on main are automically deployed on the staging environment</p>
<p>Deployment to other env have to be manually triggered</p>
<hr />
<h3 id="deployement-process">Deployement process<a class="headerlink" href="#deployement-process" title="Permanent link">#</a></h3>
<p>How a new version of Iaso is deployed</p>
<p>This is a simplified view, some details are omitted for clarity</p>
<ol>
<li>A user trigger the deploy worflow in github actions (or it is trigger automatically for staging)</li>
<li>In the github worker: (code in .github/workflows/deploy.yml)<ol>
<li>Determine version number. Call set_version to set it.</li>
<li>It build all the JS/CSS and other ressource for the front-end</li>
<li>Add the to the git repo</li>
<li>scripts/eb-deploy.py:<ol>
<li>Connect to the AWS api to fetch all the <em>beanstalk environments</em> for the <code>iaso</code> environment. e.g. : <code>staging</code> -&gt; <code>iaso-staging2</code> and <code>iaso-staging2-worker</code></li>
<li>For each beanstalk env, trigger <code>eb deploy</code> (from awseb cli):<ol>
<li>Make a zip file of the content of the git repo (done by eb deploy). Including the compiled asset</li>
<li>Call ElasticBeanstalk API to deploy it</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>In the Iaso servers (EC2 instances): Our code/config for this is in the directory <code>.ebextensions</code> Action markqe with ¥ are part of Elastic beanstalk logic<ol>
<li>Deployment is triggered ¥</li>
<li>New app version is copied in <code>/var/app/staging</code> ¥</li>
<li>The dependencies in requirements.txt are installed  ¥</li>
<li><a href="https://github.com/BLSQ/iaso/blob/main/.ebextensions/50_container_commands.config">Our logic</a> is executed<ol>
<li>Server translations are compiled</li>
<li><strong>The frontend (compiled JS, image, css) is pushed to the S3 bucket.</strong></li>
<li><strong>Database migration are done</strong></li>
<li>Cache table is created</li>
</ol>
</li>
<li><code>/var/app/staging</code> is moved in <code>/var/app/current</code> ¥</li>
<li>If these steps fail, Elastic beanstalk will do a <em>rollback</em> and revert to the previous version. Note since we do manually the maching between worker and web, sometime we have the problem that one is rolled back and not the other and we have a version mismatch. We sometime also have the problem with incompatible database migrations. ¥</li>
<li>Send a Slack notification to notify of the success of failure of the github deployment.</li>
</ol>
</li>
</ol>
<hr />
<h1 id="related-services-in-more-details">Related services in more details<a class="headerlink" href="#related-services-in-more-details" title="Permanent link">#</a></h1>
<ul>
<li>S3 bucket: For the static and the user uploaded media (in AWS)</li>
<li>Enketo (in another AWS Elastic Beanstalk)</li>
<li>Postgresql RDS (in AWS)</li>
<li>Queue Service for background Worker  (in AWS SQS)</li>
<li>Sentry: error handling and notification (as Saas)</li>
<li>MailGun (as Saas)</li>
<li>Route53: DNS redirection (in AWS)</li>
</ul>
<hr />
<h3 id="enketo">Enketo<a class="headerlink" href="#enketo" title="Permanent link">#</a></h3>
<p>Deployed separately, handled via Elastic Beanstalk also, linked to Iaso via environment variable. Mbayang manage this</p>
<hr />
<h3 id="aws-sqs">AWS SQS<a class="headerlink" href="#aws-sqs" title="Permanent link">#</a></h3>
<p>Queue system used for Worker, see worker section in README</p>
<hr />
<h3 id="s3-bucket_1">S3 bucket<a class="headerlink" href="#s3-bucket_1" title="Permanent link">#</a></h3>
<p>S3 see above</p>
<h1 id="architecture-inside-the-vm">Architecture inside the VM<a class="headerlink" href="#architecture-inside-the-vm" title="Permanent link">#</a></h1>
<p>Code is in the <code>/var/app/current</code></p>
<p>Systemctl launch the web server  as the <code>web</code> unit. This is done via Gunicorn under the web user, gunicorn launch multiple Django server.</p>
<p>There is a NGINX in front of gunicorn.
The above is handled automatically via Iaso</p>
<p>The logs can be listed inside the VM via <code>journalctl -u web</code></p>
<p>We have 2 crons (for now). They can be seen  by using <code>systemctl list-timers</code></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/BLSQ/iaso" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
