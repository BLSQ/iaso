<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../../../img/favicon.ico" rel="shortcut icon"/>
<title>Setup a dev environment - IASO</title>
<link href="../../../../css/theme.css" rel="stylesheet"/>
<link href="../../../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<link href="../../../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../../../stylesheets/extra.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Setup a dev environment";
        var mkdocs_page_input_path = "pages/dev/how_to/setup_dev_env/setup_dev_env.md";
        var mkdocs_page_url = null;
      </script>
<script defer="" src="../../../../js/jquery-3.6.0.min.js"></script>
<!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a href="../../../../index.html">
<img alt="Logo" class="logo" src="../../../../assets/iaso.png"/>
</a><div role="search">
<form action="../../../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_concepts/iaso_concepts.html">Concepts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_modules/iaso_modules.html">Modules</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_web/user_guide.html">Web Platform</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_mobile/iaso_mobile.html">Mobile Application</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Developers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="#">References</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/data_model_glossary/data_model_glossary.html">Data model glossary</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/sql_dashboard/SQL_Dashboard_feature.html">SQL Dashboard feature</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/docker/docker.html">Docker</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/background_tasks/background_tasks.html">Background tasks &amp; worker</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/env_variables/env_variables.html">Environnement variables</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#">Models</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/API/entity.html">API reference: Entity</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="#">How to</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../contribute/contribute.html">Contribute</a>
</li>
<li class="toctree-l2 current"><a class="reference internal current" href="setup_dev_env.html">Setup a dev environment</a>
<ul class="current">
<li class="toctree-l3"><a class="reference internal" href="#1-environment-variables">1. Environment variables</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#2-build-the-containers">2. Build the containers</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#3-start-the-database">3. Start the database</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4-run-migrations">4. Run migrations</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#5-start-the-server">5. Start the server</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#6-create-a-superuser">6. Create a superuser</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#7-create-and-import-data">7. Create and import data</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#8-create-a-form">8. Create a form</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#9-start-adding-features">9. Start adding features</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#10-import-orgunit-forms-and-submission-from-dhis2">10. Import OrgUnit, Forms and Submission from DHIS2</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#11-enketo">11. Enketo</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#12-database-dump">12. Database dump</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#13-restore-database-from-dump">13. Restore database from dump</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#14-health">14. Health</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#15-set-up-a-local-dhis2-server">15. Set up a local DHIS2 server</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#16-sample-dhis2-database">16. Sample dhis2 database</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#17-set-up-single-sign-on-sso-with-a-local-dhis2">17. Set up Single Sign On (SSO) with a local DHIS2</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#18-test-forms-from-iaso-mobile-application">18. Test forms from Iaso mobile application</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#1-setup-ngrok">1 - Setup Ngrok</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#2-setup-the-mobile-app">2 - Setup the mobile app</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#19-sso-with-dhis2">19. SSO with DHIS2</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#1-setup-oauth2-clients-in-dhis2">1 - Setup OAuth2 clients in DHIS2</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#2-configure-the-oauth2-connection-in-iaso">2 - Configure the OAuth2 connection in Iaso</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#3-workflow-for-single-sign-on-as-a-sequence-diagram">3. Workflow for Single Sign On as a sequence diagram</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#20live-bluesquare-components">20.Live Bluesquare components</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#21-task-worker">21. Task worker</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#22-customization">22. Customization</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../use_iaso_apis/use_iaso_apis.html">Use iaso apis</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">More about Iaso</span></p>
<ul>
<li class="toctree-l1"><a class="" href="https://www.openiaso.com/">Get a demo</a>
</li>
<li class="toctree-l1"><a class="" href="https://www.bluesquarehub.com/">Bluesquare</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../../../../index.html">IASO</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a alt="Docs" class="icon icon-home" href="../../../../index.html"></a> »</li>
<li>Developers »</li>
<li>How to »</li>
<li>Setup a dev environment</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/BLSQ/iaso/edit/main/docs/pages/dev/how_to/setup_dev_env/setup_dev_env.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="setup-a-dev-environment">Setup a dev environment<a class="headerlink" href="#setup-a-dev-environment" title="Permanent link">#</a></h1>
<p>A running local instance for development can be spun up via docker compose which will install and
configure all deps in separate container. As such your computer should only need:</p>
<ul>
<li><a href="https://git-scm.com/">git</a></li>
<li><a href="https://docs.docker.com/engine/installation/">docker</a></li>
<li><a href="https://docs.docker.com/compose/">docker compose</a></li>
</ul>
<p>If docker compose give you trouble, make sure it can connect to the
<strong>docker daemon</strong>.</p>
<p>If you use an Apple Silicon Mac, ensure <code>export DOCKER_DEFAULT_PLATFORM=linux/amd64</code> is set.</p>
<p>A <code>pgdata-iaso</code> folder, containing the database data, will be created in the parent directory of the git repository.</p>
<h3 id="1-environment-variables">1. Environment variables<a class="headerlink" href="#1-environment-variables" title="Permanent link">#</a></h3>
<p>The docker-compose.yml file contains sensible defaults for the Django
application.</p>
<p>Other environment variables can be provided by a <a href="https://docs.docker.com/v17.12/compose/environment-variables/#the-env-file">.env
file</a>.</p>
<p>As a starting point, you can copy the sample .env.dist file and edit it
to your needs.</p>
<pre class="bash"><code class="language-sourceCode">cp .env.dist .env
</code></pre>
<p><strong>note:</strong>
All the commands here need to be run in the project directory in which the repository was cloned</p>
<h3 id="2-build-the-containers">2. Build the containers<a class="headerlink" href="#2-build-the-containers" title="Permanent link">#</a></h3>
<p>This will build and download the containers.</p>
<pre class="bash"><code class="language-sourceCode">docker compose build
</code></pre>
<h3 id="3-start-the-database">3. Start the database<a class="headerlink" href="#3-start-the-database" title="Permanent link">#</a></h3>
<pre class="bash"><code class="language-sourceCode">docker compose up db
</code></pre>
<h3 id="4-run-migrations">4. Run migrations<a class="headerlink" href="#4-run-migrations" title="Permanent link">#</a></h3>
<pre class="bash"><code class="language-sourceCode">docker compose run --rm iaso manage migrate
</code></pre>
<p>If you get a message saying that the database iaso does not exist, you can connect to your postgres instance using </p>
<pre><code>psql -h localhost -p 5433 -U postgres
</code></pre>
<p>then type </p>
<pre><code>create database iaso; 
</code></pre>
<p>to create the missing database.</p>
<h3 id="5-start-the-server">5. Start the server<a class="headerlink" href="#5-start-the-server" title="Permanent link">#</a></h3>
<p>To start all the containers (backend, frontend, db)</p>
<pre class="bash"><code class="language-sourceCode">docker compose up
</code></pre>
<p>The web server will be reachable at <code>http://localhost:8081</code>.</p>
<p>The <code>docker-compose.yml</code> file describes the setup of the containers.</p>
<h3 id="6-create-a-superuser">6. Create a superuser<a class="headerlink" href="#6-create-a-superuser" title="Permanent link">#</a></h3>
<p>To login to the app or the Django admin, a superuser needs to be created
with:</p>
<pre class="bash"><code class="language-sourceCode">docker compose exec iaso ./manage.py createsuperuser
</code></pre>
<p>You can now login in the admin at <code>http://localhost:8081/admin</code>.</p>
<p>Then additional users with custom groups and permissions can be added
through the Django admin or loaded via fixtures.</p>
<h3 id="7-create-and-import-data">7. Create and import data<a class="headerlink" href="#7-create-and-import-data" title="Permanent link">#</a></h3>
<p>To create the initial account, project and profile, do the following:</p>
<pre class="bash"><code class="language-sourceCode">docker compose exec iaso ./manage.py create_and_import_data
</code></pre>
<p>You can now login on <code>http://localhost:8081</code> but still need to import your own data.</p>
<p>An alternative to this and the following steps is to <a href="#10-import-orgunit-forms-and-submission-from-dhis2">import data from DHIS2</a>.</p>
<h3 id="8-create-a-form">8. Create a form<a class="headerlink" href="#8-create-a-form" title="Permanent link">#</a></h3>
<p>Run the following command to create a form:</p>
<pre class="bash"><code class="language-sourceCode">docker compose exec iaso ./manage.py create_form
</code></pre>
<p>At this point, if you want to edit forms directly on your machine using
Enketo, go to the Enketo setup section of this README (down below).</p>
<p>Once you are done, you can click on the eye for your newly added form,
click on "+ Create", tap a letter, then enter, select the org unit, then
click "Create submission".</p>
<p>If Enketo is running and well setup, you can fill the form now.</p>
<h3 id="9-start-adding-features">9. Start adding features<a class="headerlink" href="#9-start-adding-features" title="Permanent link">#</a></h3>
<p>You can now start to develop additional features on Iaso!</p>
<h3 id="10-import-orgunit-forms-and-submission-from-dhis2">10. Import OrgUnit, Forms and Submission from DHIS2<a class="headerlink" href="#10-import-orgunit-forms-and-submission-from-dhis2" title="Permanent link">#</a></h3>
<p>Alternatively or in addition to steps 7-8, you can import data from the DHIS2 demo server (play.dhis2.org):</p>
<pre class="bash"><code class="language-sourceCode">docker compose run --rm iaso manage seed_test_data --mode=seed --dhis2version=2.35.3
</code></pre>
<p>The hierarchy of OrgUnit, group of OrgUnit, Forms, and their Submissions will be imported. OrgUnit types are not
handled at the moment</p>
<p>Log in to  <a href="http://127.0.0.1:8081/dashboard">http://127.0.0.1:8081/dashboard</a> with :</p>
<ul>
<li>user : testemail2.35.3</li>
<li>password: testemail2.35.3</li>
</ul>
<h3 id="11-enketo">11. Enketo<a class="headerlink" href="#11-enketo" title="Permanent link">#</a></h3>
<p>To submit and edit existing form submission from the browser, an Enketo service is needed. </p>
<p>To enable the Enketo editor in your local environment, include the additional docker compose configuration file for Enketo. Do so by invoking docker compose with both files.</p>
<pre><code>docker compose -f docker-compose.yml -f docker/docker-compose-enketo.yml up
</code></pre>
<p>No additional configuration is needed. The first time the docker image is launched, it will download dependencies and do a build witch may take a few minutes. Subsequents launches are faster.</p>
<p>You can check that the server is correctly launched by going to http://localhost:8005</p>
<p>To seed your DB with typical example forms editable by Enketo, see <a href="#10-import-orgunit-forms-and-submission-from-dhis2">import data from DHIS2</a></p>
<h3 id="12-database-dump">12. Database dump<a class="headerlink" href="#12-database-dump" title="Permanent link">#</a></h3>
<p>To create a copy of your iaso database in a file (dump) you can use:</p>
<pre><code>docker compose exec db pg_dump -U postgres iaso  -Fc &gt; iaso.dump
</code></pre>
<p>The dumpfile will be created on your host. The <code>-Fc</code> meant it will use an optimised Postgres format (which take less place). If you want the plain sql command use <code>-Fp</code></p>
<h3 id="13-restore-database-from-dump">13. Restore database from dump<a class="headerlink" href="#13-restore-database-from-dump" title="Permanent link">#</a></h3>
<ol>
<li>Ensure the database server is running but not the rest. Close your docker compose, ensure it is down with <code>docker compose down</code></li>
<li>Launch the database server with <code>docker compose up db</code> </li>
<li>Choose a name for you database. In this example  it will be <code>iaso5</code>
   You can list existing databases using <code>docker compose exec db psql -U postgres -l</code></li>
<li>Create the database <code>docker compose exec db psql -U postgres -c "create database iaso5"</code></li>
<li>Restore the dump file to put the data in your database</li>
</ol>
<pre><code>cat iaso.dump | docker compose exec -T db pg_restore -U postgres -d iaso5 -Fc --no-owner /dev/stdin
</code></pre>
<ol>
<li>Edit your <code>.env</code> file to use to this database in the <code>RDS_DB_NAME</code> settings.</li>
<li>Start Iaso. Cut your docker compose (see 0) and relaunch it fully. Warning: Modification in your .env file are not taken into account unless you entirely stop your docker compose</li>
</ol>
<h3 id="14-health">14. Health<a class="headerlink" href="#14-health" title="Permanent link">#</a></h3>
<hr/>
<p>On the /health/ url you can find listed the Iaso version number, environment, deployment time, etc... that might help you understand how this server instance is deployed for debugging. e.g.  https://iaso.bluesquare.org/health/</p>
<h3 id="15-set-up-a-local-dhis2-server">15. Set up a local DHIS2 server<a class="headerlink" href="#15-set-up-a-local-dhis2-server" title="Permanent link">#</a></h3>
<hr/>
<p>Experimental. For development if you need a local dhis2 server, you can spin up one in your docker compose by using the <code>docker/docker-compose-dhis2.yml</code> configuration file.</p>
<p>Replace your invocations of <code>docker compose</code> by <code>docker compose -f docker-compose.yml -f docker/docker-compose-dhis2.yml</code> you need to specify both config files. e.g to launch the cluster:</p>
<pre><code>docker compose -f docker-compose.yml -f docker/docker-compose-dhis2.yml up
</code></pre>
<p>The DHIS2 will be available on your computer on http://localhost:8080 and is reachable from Iaso as http://dhis2:8080. The login and password are admin / district. If you use it as an import source do not set a trailing /</p>
<p>Database file are stored in <code>../pgdata-dhis2</code> and dhis2 log and uploaded files in <code>docker/DHIS2_home</code>.</p>
<h3 id="16-sample-dhis2-database">16. Sample dhis2 database<a class="headerlink" href="#16-sample-dhis2-database" title="Permanent link">#</a></h3>
<p>You will probably require some sample data in your instance. It is possible to
populate your DHIS2 server with sample data from a database dump like it's done
for the official play servers. The DHIS2 database take around 3 GB.</p>
<p>The steps as are follow:
Download the file, stop all the docker, remove the postgres database directory, start only the database docker, load the database dump and then restart everything.</p>
<pre><code>wget https://databases.dhis2.org/sierra-leone/2.36.4/dhis2-db-sierra-leone.sql.gz
docker compose down
sudo rm ../pgdata-dhis2 -r
docker compose up db_dhis2
zcat dhis2-db-sierra-leone.sql.gz| docker compose exec -T db_dhis2 psql -U dhis dhis2 -f /dev/stdin
docker compose up
cd Projects/blsq/iaso
docker compose up dhis2 db_dhis2
</code></pre>
<h3 id="17-set-up-single-sign-on-sso-with-a-local-dhis2">17. Set up Single Sign On (SSO) with a local DHIS2<a class="headerlink" href="#17-set-up-single-sign-on-sso-with-a-local-dhis2" title="Permanent link">#</a></h3>
<p>If you want to test the feature with your local dhis2 you can use the following step. This assume you are running everything in Docker containers</p>
<ol>
<li>Launch DHIS2 with iaso within docker compose
<code>docker compose -f docker-compose.yml -f docker/docker-compose-dhis2.yml up</code>
 With the default docker compose setup, iaso is on port 8081 and dhis2 on port 8081 on your machine</li>
<li>These step assume you have loaded your DHIS2 with the play test data but it's not mandatory. To see how to do it, look at previous section</li>
<li>Configure an Oauth client in DHIS2: open http://localhost:8080/dhis-web-settings/index.html#/oauth2</li>
<li>Add new client:</li>
<li>Name : what you want</li>
<li>ClientId: What you want (must be the same as your external credential in Iaso)</li>
<li>Client Secret : there is one generated, copy it and save it for a latter step</li>
<li>Grant Type: check Authorization code</li>
<li>
<p>Redirect URI : http://localhost:8081/api/dhis2/{same as client id}/login/</p>
</li>
<li>
<p>Setup external credential in iaso</p>
</li>
<li>open admin http://localhost:8081/admin/</li>
<li>go to External Credentials | http://localhost:8081/admin/iaso/externalcredentials/</li>
<li>Add external credentials on the top right | http://localhost:8081/admin/iaso/externalcredentials/add/</li>
<li>Account: The account for which you want to enable dhis2 auth</li>
<li>Name : Same as DHIS2 Client ID</li>
<li>Login : http://dhis2:8080/</li>
<li>Password: the client secret you saved in step 2</li>
<li>Url: http://localhost:8081/</li>
</ol>
<p>5 Create a new user in Iaso, grant it some rights</p>
<ol>
<li>
<p>In DHIS2 retrieve the id for the user</p>
<ul>
<li>Current way I have found it is to go to http://localhost:8080/api/me and copy the id field</li>
<li>But you can also find a user here and it's in the url http://localhost:8080/dhis-web-user/index.html#/users</li>
</ul>
</li>
<li>
<p>Add the dhis2 id to the Iaso user : Open the target user in the iaso Admin http://localhost:8081/admin/iaso/profile/ and add it to the dhis2 id field, save.</p>
</li>
<li>
<p>Unlog from iaso or in a separate session/container</p>
</li>
<li>Try the feature by opening : http://localhost:8080/uaa/oauth/authorize?client_id={your_dhis2_client_id}&amp;response_type=code</li>
</ol>
<h3 id="18-test-forms-from-iaso-mobile-application">18. Test forms from Iaso mobile application<a class="headerlink" href="#18-test-forms-from-iaso-mobile-application" title="Permanent link">#</a></h3>
<h4 id="1-setup-ngrok">1 - Setup Ngrok<a class="headerlink" href="#1-setup-ngrok" title="Permanent link">#</a></h4>
<p>Download and setup Ngrok on https://ngrok.com/. Once Ngrok installed and running you must add your ngrok server url
in <code>settings.py</code> by adding the following line :</p>
<pre><code>FILE_SERVER_URL = os.environ.get("FILE_SERVER_URL", "YOUR_NGROK_SERVER_URL")
</code></pre>
<p>After this step you have to import  <code>settings.py</code> and add <code>FILE_SERVER_URL</code> to <code>forms.py</code> in iaso/models/forms as
shown on the following lines :</p>
<pre><code>"file": settings.FILE_SERVER_URL + self.file.url,
"xls_file": settings.FILE_SERVER_URL + self.xls_file.url if self.xls_file else None
</code></pre>
<h4 id="2-setup-the-mobile-app">2 - Setup the mobile app<a class="headerlink" href="#2-setup-the-mobile-app" title="Permanent link">#</a></h4>
<p>Once Ngrok installed and running you have to run the app in developer mode (tap 10 times on the Iaso icon at start ) and connect the mobile app to your server
by selecting the 3 dots in the top right corner and select "change server url". When connected to your server, refresh
all data and your app will be ready and connected to your development server.</p>
<h3 id="19-sso-with-dhis2">19. SSO with DHIS2<a class="headerlink" href="#19-sso-with-dhis2" title="Permanent link">#</a></h3>
<p>You can use DHIS2 as identity provider to login on Iaso. It requires a little configuration on DHIS2 and Iaso in order
to achieve that. </p>
<h4 id="1-setup-oauth2-clients-in-dhis2">1 - Setup OAuth2 clients in DHIS2<a class="headerlink" href="#1-setup-oauth2-clients-in-dhis2" title="Permanent link">#</a></h4>
<p>In DHIS2 settings you must setup your Iaso instance as Oauth2 Clients. Client ID and Grant types must be :
* Client ID : What you want (Must be the same as your external credential name in Iaso)
* Grant Types : Authorization code</p>
<p>Redirect URIs is your iaso server followed by : <code>/api/dhis2/{your_dhis2_client_id}/login/</code></p>
<p>For example : https://myiaso.com/api/dhis2/dhis2_client_id/login/</p>
<h4 id="2-configure-the-oauth2-connection-in-iaso">2 - Configure the OAuth2 connection in Iaso<a class="headerlink" href="#2-configure-the-oauth2-connection-in-iaso" title="Permanent link">#</a></h4>
<p>In iaso you must setup your dhis2 server credentials. 
To do so, go to <code>/admin</code> and setup as follow :  </p>
<ul>
<li>Name: {your_dhis2_client_id} ( It must be exactly as it is in your DHIS2 client_id and DHIS2 Redirect URIs)</li>
<li>Login: Your DHIS2 url (Ex : https://sandbox.dhis2.org/ )</li>
<li>Password: The secret provided by DHIS2 when you created your OAuth2 client.</li>
<li>Url: Your Iaso Url (Ex: https://myiaso.com/)</li>
</ul>
<p>Don't forget the <code>/</code> at the end of the urls.</p>
<h4 id="3-workflow-for-single-sign-on-as-a-sequence-diagram">3. Workflow for Single Sign On as a sequence diagram<a class="headerlink" href="#3-workflow-for-single-sign-on-as-a-sequence-diagram" title="Permanent link">#</a></h4>
<div class="mermaid">sequenceDiagram
    autonumber
    Note right of Browser: user open url to login
    Browser-&gt;&gt;DHIS2: GET /uaa/oauth/authorize&lt;br&gt;?client_id={your_dhis2_client_id}
    loop if not logged
        DHIS2-&gt;&gt;Browser: Login screen
        Browser-&gt;&gt;DHIS2: Enter credentials
        DHIS2-&gt;&gt;Browser: Login ok
    end
    DHIS2 --&gt;&gt; Browser: 200 Authorize Iaso? Authorize/Deny
    Browser -&gt;&gt; DHIS2: POST /authorize
    DHIS2 --&gt;&gt; Browser: 303  redirect
    Browser -&gt;&gt; IASO: GET /api/dhis2/&lt;dhis2_slug&gt;/login/?code=
    IASO -&gt;&gt; DHIS2: POST /uaa/oauth/token/
    DHIS2 --&gt;&gt; IASO: access token
    IASO -&gt;&gt; DHIS2 : GET /api/me
    DHIS2 --&gt;&gt; IASO: credential info
    Note right of IASO: find matching IASO user
    Note right of IASO: Log in session
    IASO --&gt;&gt; Browser: 303 Redirect &amp; set cookies
    Browser -&gt;&gt; IASO: Use iaso normally as logged user.
</div>
<h3 id="20live-bluesquare-components">20.Live Bluesquare components<a class="headerlink" href="#20live-bluesquare-components" title="Permanent link">#</a></h3>
<p>It is possible to configure the project to load a version of <a href="https://github.com/BLSQ/bluesquare-components">Bluesquare components</a> from a local git repository instead of the one installed from a package. This enabled to develop feature necessitating modification in the components code.</p>
<p>To do so:
 * place the repository in the parent repository of Iaso <code>../bluesquare-components/</code>
 * install the dependency for bluesquare-component by running npm install in its directory
 * set the environment variable <code>LIVE_COMPONENTS=true</code>
 * start your docker compose</p>
<pre><code>cd ..
git clone git@github.com:BLSQ/bluesquare-components.git
cd  bluesquare-components
npm install
cd ../iaso
LIVE_COMPONENTS=true docker compose up
</code></pre>
<p>This way the page will reload automatically if you make a change to the bluesquare-components code.</p>
<p>This functionality also works if you launch webpack outside of docker.</p>
<p>If you encounter any problem, first check that your repo is on the correct branch and the deps are up-to-date</p>
<h3 id="21-task-worker">21. Task worker<a class="headerlink" href="#21-task-worker" title="Permanent link">#</a></h3>
<p>In local development, you can run a worker for background tasks by using the command:</p>
<pre><code>docker compose run iaso manage tasks_worker
</code></pre>
<p>Alternatively, you can call the url <code>tasks/run_all</code> which will run all the pending tasks in queue.</p>
<h3 id="22-customization">22. Customization<a class="headerlink" href="#22-customization" title="Permanent link">#</a></h3>
<p>You can override default application title, logo and colors using the <code>.env</code> file and specify those variables:</p>
<pre><code>THEME_PRIMARY_COLOR="&lt;hexa_color&gt;"
THEME_PRIMARY_BACKGROUND_COLOR="&lt;hexa_color&gt;"
THEME_SECONDARY_COLOR="&lt;hexa_color&gt;"
APP_TITLE="&lt;app_title&gt;"
FAVICON_PATH="&lt;path_in_static_folder&gt;"
LOGO_PATH="&lt;path_in_static_folder&gt;"
SHOW_NAME_WITH_LOGO="&lt;'yes' or 'no'&gt;"
</code></pre>
<p>Those settings are optional and are using a default value if nothing is provided</p>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../contribute/contribute.html" title="Contribute"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../use_iaso_apis/use_iaso_apis.html" title="Use iaso apis">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/BLSQ/iaso" style="color: #fcfcfc"> GitHub</a>
</span>
<span><a href="../contribute/contribute.html" style="color: #fcfcfc">« Previous</a></span>
<span><a href="../use_iaso_apis/use_iaso_apis.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '../../../..';</script>
<script defer="" src="../../../../js/theme_extra.js"></script>
<script defer="" src="../../../../js/theme.js"></script>
<script defer="" src="../../../../search/main.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
<script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script><script>mermaid.initialize({});</script></body>
</html>
