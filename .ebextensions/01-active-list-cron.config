##
# Elastic Beanstalk configuration for Active List plugin cron jobs
# This configuration ensures cron jobs run only when PLUGINS contains "active_list"
##

files:
  "/tmp/check_active_list_plugin.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Check if PLUGINS environment variable contains "active_list"
      if [[ "$PLUGINS" == *"active_list"* ]]; then
        echo "active_list plugin is enabled"
        exit 0
      else
        echo "active_list plugin is not enabled"
        exit 1
      fi

  "/tmp/conditional_cron.yaml":
    mode: "000644"
    owner: root
    group: root
    content: |
      version: 1
      cron:
       - name: "send_preparedness_weekly_email"
         url: "/tasks/launch_task/plugins.polio.tasks.weekly_email.send_email/polio_cron_task_user/"
         schedule : "0 1 * * 5"
       - name: "refresh_preparedness_data_task"
         url: "/tasks/launch_task/plugins.polio.tasks.refresh_preparedness_data.refresh_data/polio_cron_task_user/"
         schedule: "30 5 * * *"
       - name: "send_email_vaccine_authorizations_60_days_expiration_alert"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.send_email_vaccine_authorizations_60_days_expiration_alert/polio_cron_task_user/"
         schedule: "30 3 * * *"
       - name: "send_email_expired_vaccine_authorizations_alert"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.send_email_expired_vaccine_authorizations_alert/polio_cron_task_user/"
         schedule: "30 3 * * *"
       - name: "vaccine_authorization_update_expired_entries"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.vaccine_authorization_update_expired_entries/polio_cron_task_user/"
         schedule: "0 3 * * *"
       - name: "vaccine_stock_history_update_for_rounds"
         url: "/tasks/launch_task/plugins.polio.tasks.archive_vaccine_stock_for_rounds.archive_vaccine_stock_for_rounds/polio_cron_task_user/"
         schedule: "0 2 * * *"

  "/tmp/active_list_cron.yaml":
    mode: "000644"
    owner: root
    group: root
    content: |
      version: 1
      cron:
       - name: "send_preparedness_weekly_email"
         url: "/tasks/launch_task/plugins.polio.tasks.weekly_email.send_email/polio_cron_task_user/"
         schedule : "0 1 * * 5"
       - name: "refresh_preparedness_data_task"
         url: "/tasks/launch_task/plugins.polio.tasks.refresh_preparedness_data.refresh_data/polio_cron_task_user/"
         schedule: "30 5 * * *"
       - name: "send_email_vaccine_authorizations_60_days_expiration_alert"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.send_email_vaccine_authorizations_60_days_expiration_alert/polio_cron_task_user/"
         schedule: "30 3 * * *"
       - name: "send_email_expired_vaccine_authorizations_alert"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.send_email_expired_vaccine_authorizations_alert/polio_cron_task_user/"
         schedule: "30 3 * * *"
       - name: "vaccine_authorization_update_expired_entries"
         url: "/tasks/launch_task/plugins.polio.tasks.vaccine_authorizations_mail_alerts.vaccine_authorization_update_expired_entries/polio_cron_task_user/"
         schedule: "0 3 * * *"
       - name: "vaccine_stock_history_update_for_rounds"
         url: "/tasks/launch_task/plugins.polio.tasks.archive_vaccine_stock_for_rounds.archive_vaccine_stock_for_rounds/polio_cron_task_user/"
         schedule: "0 2 * * *"
       - name: "export_entities_to_records"
         url: "/tasks/launch_task/plugins.active_list.management.commands.export_entities_to_records.Command/active_list_cron_user/"
         schedule: "* * * * *"
       - name: "export_records_to_entities"
         url: "/tasks/launch_task/plugins.active_list.management.commands.export_records_to_entities.Command/active_list_cron_user/"
         schedule: "* * * * *"

commands:
  01_setup_conditional_cron:
    command: |
      # Check if PLUGINS environment variable contains "active_list"
      if [[ "$PLUGINS" == *"active_list"* ]]; then
        echo "Active List plugin detected - enabling active_list cron jobs"
        cp /tmp/active_list_cron.yaml /opt/elasticbeanstalk/tasks/tabbundle/cron.yaml
      else
        echo "Active List plugin not detected - using standard cron jobs"
        cp /tmp/conditional_cron.yaml /opt/elasticbeanstalk/tasks/tabbundle/cron.yaml
      fi
    env:
      PLUGINS: 
        Ref: PLUGINS