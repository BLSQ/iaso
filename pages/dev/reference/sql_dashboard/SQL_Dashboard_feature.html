<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>SQL Dashboard feature - IASO</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "SQL Dashboard feature";
        var mkdocs_page_input_path = "pages/dev/reference/sql_dashboard/SQL_Dashboard_feature.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../../index.html">
          <img src="../../../../assets/iaso.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Users</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_concepts/iaso_concepts.html">Concepts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_modules/iaso_modules.html">Modules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_web/user_guide.html">Web Platform</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../users/reference/iaso_mobile/iaso_mobile.html">Mobile Application</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">References</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../data_model_glossary/data_model_glossary.html">Data model glossary</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="SQL_Dashboard_feature.html">SQL Dashboard feature</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#bar-charts">Bar charts</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#example-number-of-org-unit-per-type-in-a-project">Example: Number of Org Unit per type in a project</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#orgunit-hierarchy-linked-to-an-org-unit">OrgUnit hierarchy linked to an org unit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#use-of-parameters">Use of parameters</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#example-number-of-submission-per-form-and-per-org_unit-in-a-particular-sourceversion-version_id">Example number of submission per form and per org_unit in a particular SourceVersion (version_id)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#use-multiple-ids">Use multiple ids</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-line-chart">Multi Line chart</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#example-cumulative-submission-per-projects-per-month">Example cumulative submission per projects per month</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../docker/docker.html">Docker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../background_tasks/background_tasks.html">Background tasks & worker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../env_variables/env_variables.html">Environnement variables</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../API/entity.html">API reference: Entity</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">How to</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../how_to/contribute/contribute.html">Contribute</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../how_to/setup_dev_env/setup_dev_env.html">Setup a dev environment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../how_to/use_iaso_apis/use_iaso_apis.html">Use iaso apis</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">More about Iaso</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://www.openiaso.com/">Get a demo</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://www.bluesquarehub.com/">Bluesquare</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">IASO</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Developers &raquo;</li>
          <li>References &raquo;</li>
      <li>SQL Dashboard feature</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/BLSQ/iaso/edit/main/docs/pages/dev/reference/sql_dashboard/SQL_Dashboard_feature.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>For super user across account there is a way to run raw read only SQL queries at the <code>/explore/</code> page : <a href="https://iaso.bluesquare.org/explore/">https://iaso.bluesquare.org/explore/</a>
e.g <a href="https://iaso.bluesquare.org/explore/?sql=select+name+from+iaso_orgunittype%3AMRkVISqY7UEDGEyyUtdg1A7sxl2eaHNOtgr6fqbkLj4">SELECT name FROM iaso_orgunittype</a></p>
<p>This is useful to check the database state and query data accross different client account. You can also save query and share them with others.</p>
<p>This feature is implemented via the excellent Django SQL Dashboard, their documentation has more complete information: 
https://django-sql-dashboard.datasette.io/en/stable/index.html</p>
<h1 id="tips">Tips<a class="headerlink" href="#tips" title="Permanent link">#</a></h1>
<h2 id="bar-charts">Bar charts<a class="headerlink" href="#bar-charts" title="Permanent link">#</a></h2>
<p>You can generate bar chart by having two column named <code>bar_label</code>  and <code>bar_quantity</code></p>
<p>Examples</p>
<h3 id="example-number-of-org-unit-per-type-in-a-project">Example: Number of Org Unit per type in a project<a class="headerlink" href="#example-number-of-org-unit-per-type-in-a-project" title="Permanent link">#</a></h3>
<pre><code class="language-sql">select iaso_orgunittype.name as bar_label, count(org_unit.id) as bar_quantity  
from iaso_orgunittype  
    join iaso_orgunittype_projects on iaso_orgunittype.id = iaso_orgunittype_projects.orgunittype_id  
    left join iaso_orgunit org_unit on iaso_orgunittype.id = org_unit.org_unit_type_id  
    where iaso_orgunittype_projects.project_id = 1  
group by iaso_orgunittype.id  
order by  bar_quantity
</code></pre>
<p><img alt="Example sql bar chart.png" src="Example%20sql%20bar%20chart.png" /></p>
<h2 id="orgunit-hierarchy-linked-to-an-org-unit">OrgUnit hierarchy linked to an org unit<a class="headerlink" href="#orgunit-hierarchy-linked-to-an-org-unit" title="Permanent link">#</a></h2>
<pre><code class="language-sql">SELECT * FROM iaso_orgunit WHERE path ~ '*.104133.*'
</code></pre>
<h2 id="use-of-parameters">Use of parameters<a class="headerlink" href="#use-of-parameters" title="Permanent link">#</a></h2>
<p>You can use parameter, this will automatically create an input.</p>
<p>If you save them as a dashboard it will allow passing the paramter in the url</p>
<h3 id="example-number-of-submission-per-form-and-per-org_unit-in-a-particular-sourceversion-version_id">Example number of submission per form and per org_unit in a particular SourceVersion (version_id)<a class="headerlink" href="#example-number-of-submission-per-form-and-per-org_unit-in-a-particular-sourceversion-version_id" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT &quot;iaso_orgunit&quot;.&quot;path&quot;,  
       &quot;iaso_orgunit&quot;.&quot;name&quot;,  
       &quot;iaso_instance&quot;.&quot;form_id&quot;,  
       count(&quot;iaso_instance&quot;.&quot;id&quot;) filter  
           (WHERE (not (&quot;iaso_instance&quot;.&quot;file&quot; = '' and &quot;iaso_instance&quot;.&quot;file&quot; is not null) and  
                   not (&quot;iaso_instance&quot;.&quot;deleted&quot; and &quot;iaso_instance&quot;.&quot;deleted&quot; is not null))) as &quot;instances_count&quot;  

FROM &quot;iaso_orgunit&quot;  
         JOIN &quot;iaso_instance&quot;  
              ON (&quot;iaso_orgunit&quot;.&quot;id&quot; = &quot;iaso_instance&quot;.&quot;org_unit_id&quot;)  
                  and version_id = %(version_id)s
GROUP BY &quot;iaso_orgunit&quot;.path, &quot;iaso_orgunit&quot;.&quot;id&quot;, &quot;iaso_instance&quot;.&quot;form_id&quot;  
order by &quot;iaso_orgunit&quot;.path  
limit 100;
</code></pre>
<h3 id="use-multiple-ids">Use multiple ids<a class="headerlink" href="#use-multiple-ids" title="Permanent link">#</a></h3>
<p>This tips is useful to allow passing multiple ids, separated per <code>,</code></p>
<pre><code class="language-sql">select * from iaso_form where
iaso_form.id = ANY (string_to_array(%(form_ids)s::text, ',')::int[])
</code></pre>
<h2 id="multi-line-chart">Multi Line chart<a class="headerlink" href="#multi-line-chart" title="Permanent link">#</a></h2>
<p>You can generate multi line chart by naming columns <code>line_label</code>, <code>line_quantity</code> and <code>line_category</code> (you need all three)</p>
<p><img alt="Example multi line chart.png" src="Example%20multi%20line%20chart.png" /></p>
<h3 id="example-cumulative-submission-per-projects-per-month">Example cumulative submission per projects per month<a class="headerlink" href="#example-cumulative-submission-per-projects-per-month" title="Permanent link">#</a></h3>
<pre><code class="language-sql">select line_label,
       line_category,
       sum(line_quantity) over (PARTITION BY line_category order by line_label) as line_quantity
from (
select TO_CHAR(date_trunc('month', COALESCE(iaso_instance.source_created_at, iaso_instance.created_at)), 'YYYY/MM') as line_label, count(*) as line_quantity,  iaso_project.name as line_category from iaso_instance inner join iaso_project on iaso_instance.project_id = iaso_project.id
 group by line_label, iaso_project.name order by line_label, line_quantity desc limit 200
) as data
</code></pre>
<h1 id="cumulative-sum">Cumulative sum<a class="headerlink" href="#cumulative-sum" title="Permanent link">#</a></h1>
<p>To generate a cumulative sum (particularly useful for progression over time). Wrap your query with</p>
<pre><code class="language-sql">select line_label,
       line_category,
       sum(line_quantity) over (PARTITION BY line_category order by line_label) as line_quantity
from (
 YOUR QUERY
) as data
</code></pre>
<p>See previous example.</p>
<h3 id="random-data-generation-example">random data generation example<a class="headerlink" href="#random-data-generation-example" title="Permanent link">#</a></h3>
<pre><code class="language-sql">select line_label,  
       line_category,  
       sum(line_quantity) over (PARTITION BY line_category order by line_label) as line_quantity  
from (select TO_CHAR(gen_date.generate_series, 'YYYY/MM') as line_label,  
             (random() - 0.2) * 1000::int                 as line_quantity,  
             name                                         as line_category  
      from (select *  
            from generate_series('2008-03-01 08:00'::timestamp,  
                                 '2009-03-04 12:00'::timestamp, '1 month')) gen_date  
               cross join (VALUES ('foo'), ('bar'), ('baz')) as categories (name)) as data
</code></pre>
<h1 id="searching-in-org-units-org-unit-types">Searching in Org Units, Org Unit Types<a class="headerlink" href="#searching-in-org-units-org-unit-types" title="Permanent link">#</a></h1>
<p>Here are some examples of queries to find Org Units, their types, reference forms and everything linked to the hierarchy of a specific Org Unit.</p>
<p>As we are using Postgre's <a href="https://www.postgresql.org/docs/9.6/ltree.html">ltree extension</a> and <a href="https://github.com/mariocesar/django-ltree">django-ltree</a> to model this hierarchy, specific SQL operators are available to search in a performant way and queries can be cumbersome.</p>
<p>Let's say you have a OrgUnit with ID : <strong>XXXXXX</strong></p>
<h3 id="find-the-hierarchy-linked-to-this-org-unit">Find the hierarchy linked to this Org Unit.<a class="headerlink" href="#find-the-hierarchy-linked-to-this-org-unit" title="Permanent link">#</a></h3>
<pre><code class="language-SQL">SELECT * FROM iaso_orgunit WHERE path ~ '*.XXXXXX.*'
</code></pre>
<h3 id="find-the-related-org-unit-types">Find the related Org Unit Types :<a class="headerlink" href="#find-the-related-org-unit-types" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_orgunittype WHERE id IN 
    (SELECT org_unit_type_id FROM iaso_orgunit WHERE path ~ '*.XXXXXX.*')
</code></pre>
<h3 id="reference-forms-of-these-org-unit-types">Reference forms of these Org Unit Types<a class="headerlink" href="#reference-forms-of-these-org-unit-types" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_form WHERE id IN 
    (SELECT reference_form_id FROM iaso_orgunittype WHERE id IN 
        (SELECT org_unit_type_id FROM iaso_orgunit WHERE path ~ '*.XXXXXX.*'))
</code></pre>
<h3 id="find-the-form-versions-of-these-reference-forms">Find the Form Versions of these Reference Forms.<a class="headerlink" href="#find-the-form-versions-of-these-reference-forms" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_formversion WHERE id IN 
    (SELECT id FROM iaso_form WHERE id IN 
        (SELECT reference_form_id FROM iaso_orgunittype WHERE id IN 
            (SELECT org_unit_type_id FROM iaso_orgunit WHERE path ~ '*.XXXXXX.*')))
</code></pre>
<h3 id="the-instances-linked-to-that-hierarchy">The Instances linked to that hierarchy<a class="headerlink" href="#the-instances-linked-to-that-hierarchy" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_instance WHERE org_unit_id IN 
    (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*')
</code></pre>
<h3 id="finding-the-projects-linked-to-that-hierarchy">Finding the projects linked to that hierarchy<a class="headerlink" href="#finding-the-projects-linked-to-that-hierarchy" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_project WHERE id in 
    (SELECT project_id FROM iaso_instance WHERE org_unit_id IN 
        (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*'))
</code></pre>
<h3 id="devices-linked-to-that-hierarchy">Devices linked to that hierarchy<a class="headerlink" href="#devices-linked-to-that-hierarchy" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_device WHERE id in 
    (SELECT device_id FROM iaso_instance WHERE org_unit_id IN 
        (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*'))
</code></pre>
<h3 id="accounts-linked-to-these-projects">Accounts linked to these projects<a class="headerlink" href="#accounts-linked-to-these-projects" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_account WHERE id IN 
    (SELECT account_id FROM iaso_project WHERE id in 
        (SELECT project_id FROM iaso_instance WHERE org_unit_id IN 
            (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*')))
</code></pre>
<h3 id="source-versions-linked-to-these-projects">Source versions linked to these projects<a class="headerlink" href="#source-versions-linked-to-these-projects" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_sourceversion WHERE id IN
    (SELECT default_version_id FROM iaso_account WHERE id IN 
        (SELECT account_id FROM iaso_project WHERE id in 
            (SELECT project_id FROM iaso_instance WHERE org_unit_id IN 
                (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*'))))
</code></pre>
<h3 id="datasources-linked-to-these-versions">Datasources linked to these versions<a class="headerlink" href="#datasources-linked-to-these-versions" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_datasource WHERE id IN (SELECT data_source_id FROM iaso_sourceversion WHERE id IN
(SELECT default_version_id FROM iaso_account WHERE id IN 
    (SELECT account_id FROM iaso_project WHERE id in 
        (SELECT project_id FROM iaso_instance WHERE org_unit_id IN 
            (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*')))))
</code></pre>
<h3 id="credentials-linked-these-datasources">Credentials linked these datasources<a class="headerlink" href="#credentials-linked-these-datasources" title="Permanent link">#</a></h3>
<pre><code class="language-sql">SELECT * FROM iaso_externalcredentials WHERE id IN (SELECT credentials_id FROM iaso_datasource WHERE id IN (SELECT data_source_id FROM iaso_sourceversion WHERE id IN
(SELECT default_version_id FROM iaso_account WHERE id IN 
    (SELECT account_id FROM iaso_project WHERE id in 
        (SELECT project_id FROM iaso_instance WHERE org_unit_id IN 
            (SELECT id FROM iaso_orgunit WHERE path ~ '*.104133.*'))))))
</code></pre>
<h1 id="restrictions">Restrictions<a class="headerlink" href="#restrictions" title="Permanent link">#</a></h1>
<p>This functionality is severly restricted to prevent the risk of data leak and security issues:</p>
<ul>
<li>Only a certain set of table are accessible. (notably not the user table password)</li>
<li>Since this is ignore the multi tenant rule only super user can be given access to it</li>
<li>Access is read only (see implementation detail)</li>
</ul>
<h1 id="configuration-and-implementation-detail">Configuration and Implementation detail<a class="headerlink" href="#configuration-and-implementation-detail" title="Permanent link">#</a></h1>
<p>To garantee read only access this feature use a separate user that should only be given restricted right.</p>
<p>The functionnality is automatically enabled if this user is set via the <code>DB_READONLY_USERNAME</code> environment variable.</p>
<p>To configure it:
Create a Postgresql user with a password and no acess and give him the role <code>readonlyrole</code>.
You can do so using the sql command</p>
<pre><code class="language-sql">GRANT readonlyrole to YOUR_USER
</code></pre>
<p>Set the environment variable <code>DB_READONLY_USERNAME</code> and <code>DB_READONLY_PASSWORD</code>.</p>
<p>Some migration will give read acess to the certain tables to the <code>readonlyrole</code>, should you give access to more table use the command</p>
<pre><code class="language-sql">GRANT SELECT ON TABLE   
 iaso_new_table_1,
 iaso_new_table_2,
TO &quot;readonlyrole&quot;;
</code></pre>
<p>to only give access to certain column on a table</p>
<pre><code class="language-sql">GRANT SELECT(  
  id, username, is_active, date_joined  
) ON auth_user TO &quot;readonlyrole&quot;;
</code></pre>
<p>See also https://django-sql-dashboard.datasette.io/en/stable/security.html</p>
<h1 id="in-local-dev">In local dev<a class="headerlink" href="#in-local-dev" title="Permanent link">#</a></h1>
<p>this feature is automatically enabled.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../data_model_glossary/data_model_glossary.html" class="btn btn-neutral float-left" title="Data model glossary"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../docker/docker.html" class="btn btn-neutral float-right" title="Docker">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/BLSQ/iaso" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../data_model_glossary/data_model_glossary.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../docker/docker.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme_extra.js" defer></script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="../../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
