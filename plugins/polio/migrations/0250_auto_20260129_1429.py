# Generated by Django 4.2.27 on 2026-01-29 14:29

from django.db import migrations, transaction
from django.db.models import Count


def split_multi_type_campaigns(apps, schema_editor):
    Campaign = apps.get_model("polio", "Campaign")
    CampaignType = apps.get_model("polio", "CampaignType")
    CampaignScope = apps.get_model("polio", "CampaignScope")
    Round = apps.get_model("polio", "Round")
    RoundScope = apps.get_model("polio", "RoundScope")
    Subactivity = apps.get_model("polio", "Subactivity")
    SubactivityScope = apps.get_model("polio", "SubactivityScope")
    Group = apps.get_model("iaso", "Group")

    campaigns = (
        Campaign.objects.prefetch_related(
            "campaign_types",
            "rounds",
            "rounds__scopes",
            "rounds__scopes__group__org_units",
            "scopes",
            "scopes__group__org_units",
            "account",
            "rounds__sub_activities",
            "rounds__sub_activities__scopes",
            "rounds__sub_activities__scopes__group__org_units",
        )
        .annotate(campaign_types_count=Count("campaign_types"))
        .filter(campaign_types_count__gt=1)
    )
    with transaction.atomic():
        for campaign in campaigns:
            is_polio = campaign.campaign_types.filter(slug="polio").exists()
            if is_polio:
                extra_types = campaign.campaign_types.exclude(slug="polio")
                for c_type in extra_types:
                    new_obr_name = f"{campaign.obr_name}_{c_type.slug}"
                    new_campaign = Campaign.objects.create(
                        account=campaign.account,
                        obr_name=new_obr_name,
                        epid=campaign.epid,
                        initial_org_unit=campaign.initial_org_unit,
                        is_preventive=campaign.is_preventive,
                        is_test=campaign.is_test,
                        on_hold=campaign.on_hold,
                        is_planned=campaign.is_planned,
                        gpei_coordinator=campaign.gpei_coordinator,
                        gpei_email=campaign.gpei_email,
                        description=campaign.description,
                        separate_scopes_per_round=campaign.separate_scopes_per_round,
                        enable_send_weekly_email=campaign.enable_send_weekly_email,
                    )
                    if not campaign.separate_scopes_per_round:
                        new_campaign_scopes = []
                        for scope in campaign.scopes.all():
                            group = Group.objects.create(name="hidden round scope")
                            new_scope = CampaignScope.objects.create(
                                vaccine=scope.vaccine, campaign=new_campaign, group=group
                            )
                            new_scope.group.org_units.set(scope.group.org_units.all())
                            new_campaign_scopes.append(new_scope)
                        new_campaign.scopes.set(new_campaign_scopes)

                    new_rounds = []
                    for rnd in campaign.rounds.all():
                        new_round = Round.objects.create(
                            number=rnd.number,
                            started_at=rnd.started_at,
                            ended_at=rnd.ended_at,
                            age_min=rnd.age_min,
                            age_max=rnd.age_max,
                            age_type=rnd.age_type,
                            target_population=rnd.target_population,
                            percentage_covered_target_population=rnd.percentage_covered_target_population,
                            on_hold=rnd.on_hold,
                            is_planned=rnd.is_planned,
                            mop_up_started_at=rnd.mop_up_started_at,
                            mop_up_ended_at=rnd.mop_up_ended_at,
                        )
                        if campaign.separate_scopes_per_round:
                            new_round_scopes = []
                            for scope in rnd.scopes.all():
                                group = Group.objects.create(name="hidden round scope")
                                new_scope = RoundScope.objects.create(
                                    vaccine=scope.vaccine, round=new_round, group=group
                                )
                                new_scope.group.org_units.set(scope.group.org_units.all())
                                new_round_scopes.append(new_scope)
                            new_round.scopes.set(new_round_scopes)

                        new_rounds.append(new_round)
                        if rnd.sub_activities.exists():
                            new_subactivities = []
                            for subactivity in rnd.sub_activities.all():
                                new_subactivity = Subactivity.objects.create(
                                    round=new_round,
                                    name=subactivity.name,
                                    age_unit=subactivity.age_unit,
                                    age_min=subactivity.age_min,
                                    age_max=subactivity.age_max,
                                    start_date=subactivity.start_date,
                                    end_date=subactivity.end_date,
                                    im_started_at=subactivity.im_started_at,
                                    im_ended_at=subactivity.im_ended_at,
                                    lqas_started_at=subactivity.lqas_started_at,
                                    lqas_ended_at=subactivity.lqas_ended_at,
                                )
                                new_subactivity_scopes = []
                                for scope in subactivity.scopes.all():
                                    group = Group.objects.create(name="hidden round scope")
                                    new_scope = SubactivityScope.objects.create(
                                        vaccine=scope.vaccine, subactivity=new_subactivity, group=group
                                    )
                                    new_scope.group.org_units.set(scope.group.org_units.all())
                                    new_subactivity_scopes.append(new_scope)
                                new_subactivity.scopes.set(new_subactivity_scopes)
                                new_subactivities.append(new_subactivity)

                    new_campaign.rounds.set(new_rounds)
            campaign.campaign_types.set(CampaignType.objects.filter(slug="polio"))


class Migration(migrations.Migration):
    dependencies = [
        ("polio", "0249_alter_poliopermissionsupport_options"),
    ]

    operations = [migrations.RunPython(split_multi_type_campaigns, migrations.RunPython.noop)]
