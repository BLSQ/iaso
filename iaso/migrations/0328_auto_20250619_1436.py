# Generated by Django 4.2.20 on 2025-06-19 14:36

from django.db import migrations
from django.db.models.expressions import RawSQL


def migrate_data_forward(apps, schema_editor):
    Instance = apps.get_model("iaso", "Instance")

    chunk_size = 500
    instance_to_update = []

    while True:
        instances = (
            Instance.objects.filter(form_version__isnull=True, json__isnull=False)
            .annotate(
                annotated_form_version_id=RawSQL(
                    "select id from iaso_formversion where version_id = iaso_instance.json->>'_version' limit 1", ()
                )
            )
            .only("id", "form_version_id")[:chunk_size]
        )

        if not instances.exists():
            break

        for instance in instances:
            if not instance.annotated_form_version_id:
                continue
            instance.form_version_id = instance.annotated_form_version_id
            instance_to_update.append(instance)

        print(f"Updating {len(instance_to_update)} Instancesâ€¦")

        Instance.objects.bulk_update(instance_to_update, ["form_version_id"])
        instance_to_update = []

    print("Done.")


class Migration(migrations.Migration):
    atomic = False  # Prevent the migration from running in a transaction.

    dependencies = [
        ("iaso", "0327_orgunitchangerequest_deleted_at"),
    ]

    operations = [
        migrations.RunPython(migrate_data_forward, migrations.RunPython.noop, elidable=True),
    ]
