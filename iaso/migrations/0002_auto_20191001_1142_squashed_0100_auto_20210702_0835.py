# Generated by Django 3.1.14 on 2022-01-10 14:07

import uuid

import django.contrib.gis.db.models.fields
import django.contrib.postgres.fields
import django.contrib.postgres.fields.citext
import django.contrib.postgres.fields.jsonb
import django.contrib.postgres.indexes
import django.db.migrations.operations.special
import django.db.models.deletion
import django_ltree.fields  # type: ignore

from django.conf import settings
from django.db import migrations, models

import iaso.models.base
import iaso.models.forms
import iaso.utils.dhis2 as dhis2


# Functions from the following migrations need manual copying.
# Move them and any dependencies into this file, then update the
# RunPython operations to refer to the local versions:
# iaso.migrations.0052_fix_period_before_after
# iaso.migrations.0062_transfer_validation_status
# iaso.migrations.0063_form_uuid
# iaso.migrations.0065_auto_20201201_1228
# iaso.migrations.0096_add_account_feature_flag_20210621_1244
# iaso.migrations.0097_add_account_feature_flag_catchment_20210624_0808


def create_shape_account_flag(apps, schema_editor):
    AccountFeatureFlag = apps.get_model("iaso", "AccountFeatureFlag")
    AccountFeatureFlag.objects.create(code="ALLOW_SHAPE_EDITION", name="Allow shape edition in Iaso UI")


def reverse_create_shape_account_flag(apps, schema_editor):
    AccountFeatureFlag = apps.get_model("iaso", "AccountFeatureFlag")
    AccountFeatureFlag.objects.get(code="ALLOW_SHAPE_EDITION", name="Allow shape edition in Iaso UI").delete()


def create_catchment_account_flag(apps, schema_editor):
    AccountFeatureFlag = apps.get_model("iaso", "AccountFeatureFlag")
    AccountFeatureFlag.objects.create(code="ALLOW_CATCHMENT_EDITION", name="Allow catchment shape edition in Iaso UI")


def reverse_catchment_shape_account_flag(apps, schema_editor):
    AccountFeatureFlag = apps.get_model("iaso", "AccountFeatureFlag")
    AccountFeatureFlag.objects.get(
        code="ALLOW_CATCHMENT_EDITION", name="Allow catchment shape edition in Iaso UI"
    ).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("django_ltree", "0001_create_extension"),
        ("iaso", "0001_squashed_0026_adding_indexes_on_org_unit"),
        ("sites", "0002_alter_domain_unique"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ("contenttypes", "0002_remove_content_type_name"),
    ]

    operations = [
        migrations.RenameField(
            model_name="orgunit",
            old_name="source",
            new_name="sub_source",
        ),
        migrations.AlterField(
            model_name="datasource",
            name="name",
            field=models.CharField(max_length=255, unique=True),
        ),
        migrations.AlterField(
            model_name="link",
            name="validator",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
            ),
        ),
        migrations.RemoveField(
            model_name="link",
            name="algorithm",
        ),
        migrations.CreateModel(
            name="AlgorithmRun",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "algorithm",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.matchingalgorithm"),
                ),
                (
                    "launcher",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("ended_at", models.DateTimeField(blank=True, null=True)),
                ("finished", models.BooleanField(default=False)),
                ("result", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                (
                    "version_1",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="runs_where_destination",
                        to="iaso.sourceversion",
                    ),
                ),
                (
                    "version_2",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="runs_where_source",
                        to="iaso.sourceversion",
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="link",
            name="algorithm_run",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.algorithmrun"
            ),
        ),
        migrations.AddField(
            model_name="form",
            name="fields",
            field=django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="orgunittype",
            name="depth",
            field=models.PositiveSmallIntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="instance",
            name="export_id",
            field=models.TextField(blank=True, default=dhis2.generate_id_for_dhis_2, null=True),
        ),
        migrations.AlterField(
            model_name="instance",
            name="location",
            field=django.contrib.gis.db.models.fields.PointField(blank=True, null=True, srid=4326),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="location",
            field=django.contrib.gis.db.models.fields.PointField(blank=True, null=True, srid=4326),
        ),
        migrations.CreateModel(
            name="RecordType",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("description", models.TextField()),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("projects", models.ManyToManyField(blank=True, related_name="record_types", to="iaso.Project")),
            ],
        ),
        migrations.AddField(
            model_name="orgunit",
            name="catchment",
            field=django.contrib.gis.db.models.fields.PolygonField(blank=True, null=True, srid=4326),
        ),
        migrations.RemoveField(
            model_name="form",
            name="projects",
        ),
        migrations.AddField(
            model_name="datasource",
            name="projects",
            field=models.ManyToManyField(blank=True, related_name="data_sources", to="iaso.Project"),
        ),
        migrations.AddField(
            model_name="deviceownership",
            name="project",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.DO_NOTHING, to="iaso.project"
            ),
        ),
        migrations.AddField(
            model_name="instance",
            name="project",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.DO_NOTHING, to="iaso.project"
            ),
        ),
        migrations.CreateModel(
            name="Record",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("value", models.DecimalField(decimal_places=10, max_digits=19)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "org_unit",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.orgunit"
                    ),
                ),
                (
                    "version",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.sourceversion"
                    ),
                ),
                (
                    "record_type",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.recordtype"
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="account",
            name="default_version",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to="iaso.sourceversion"
            ),
        ),
        migrations.AlterField(
            model_name="project",
            name="forms",
            field=models.ManyToManyField(blank=True, related_name="projects", to="iaso.Form"),
        ),
        migrations.AddField(
            model_name="datasource",
            name="read_only",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="device",
            name="projects",
            field=models.ManyToManyField(blank=True, related_name="devices", to="iaso.Project"),
        ),
        migrations.CreateModel(
            name="Group",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("source_ref", models.TextField(blank=True, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("org_units", models.ManyToManyField(blank=True, related_name="groups", to="iaso.OrgUnit")),
                (
                    "source_version",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.sourceversion"
                    ),
                ),
            ],
        ),
        migrations.AlterField(
            model_name="sourceversion",
            name="data_source",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, related_name="versions", to="iaso.datasource"
            ),
        ),
        migrations.CreateModel(
            name="ExternalCredentials",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("login", models.TextField()),
                ("password", models.TextField()),
                ("url", models.TextField()),
                (
                    "account",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, related_name="credentials", to="iaso.account"
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="formversion",
            name="form",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, related_name="form_versions", to="iaso.form"
            ),
        ),
        migrations.AddField(
            model_name="datasource",
            name="credentials",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="data_sources",
                to="iaso.externalcredentials",
            ),
        ),
        migrations.AddField(
            model_name="form",
            name="period_type",
            field=models.TextField(
                blank=True,
                choices=[("MONTH", "Month"), ("QUARTER", "Quarter"), ("SIX_MONTH", "Six-month"), ("YEAR", "Year")],
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="form",
            name="single_per_period",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="instance",
            name="period",
            field=models.TextField(blank=True, db_index=True, null=True),
        ),
        migrations.AlterField(
            model_name="instance",
            name="form",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.DO_NOTHING,
                related_name="instances",
                to="iaso.form",
            ),
        ),
        migrations.AlterField(
            model_name="formversion",
            name="file",
            field=models.FileField(default="missing", upload_to="forms/"),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="formversion",
            name="version_id",
            field=models.TextField(default="missing"),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="formversion",
            name="file",
            field=models.FileField(upload_to=iaso.models.forms.form_version_upload_to),
        ),
        migrations.AddField(
            model_name="formversion",
            name="xls_file",
            field=models.FileField(blank=True, null=True, upload_to=iaso.models.forms.form_version_upload_to),
        ),
        migrations.AddField(
            model_name="form",
            name="periods_after_allowed",
            field=models.IntegerField(default=0),
        ),
        migrations.AddField(
            model_name="form",
            name="periods_before_allowed",
            field=models.IntegerField(default=0),
        ),
        migrations.AlterField(
            model_name="form",
            name="name",
            field=models.TextField(default="Untitled"),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="instance",
            name="form",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="instances",
                to="iaso.form",
            ),
        ),
        migrations.CreateModel(
            name="ExportLog",
            fields=[
                ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("sent", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("received", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("http_status", models.IntegerField(blank=True, null=True)),
                ("url", models.TextField(blank=True, null=True)),
            ],
        ),
        migrations.CreateModel(
            name="ExportRequest",
            fields=[
                ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("params", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("result", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("finished", models.BooleanField(default=False)),
                (
                    "status",
                    models.TextField(
                        choices=[
                            ("QUEUED", "Queued"),
                            ("RUNNING", "Running"),
                            ("EXPORTED", "Exported"),
                            ("ERRORED", "Errored"),
                            ("SKIPPED", "Skipped"),
                        ],
                        default="QUEUED",
                    ),
                ),
                ("instance_count", models.IntegerField()),
                ("exported_count", models.IntegerField()),
                ("errored_count", models.IntegerField()),
                ("last_error_message", models.TextField()),
                ("queued_at", models.DateTimeField(auto_now_add=True)),
                ("started_at", models.DateTimeField(blank=True, null=True)),
                ("ended_at", models.DateTimeField(blank=True, null=True)),
                (
                    "launcher",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="Mapping",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                (
                    "mapping_type",
                    models.TextField(choices=[("AGGREGATE", "Aggregate"), ("EVENT", "Event"), ("DERIVED", "Derived")]),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "data_source",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, related_name="mappings", to="iaso.datasource"
                    ),
                ),
                (
                    "form",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.DO_NOTHING, to="iaso.form"
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="instance",
            name="last_export_success_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.CreateModel(
            name="MappingVersion",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("json", django.contrib.postgres.fields.jsonb.JSONField()),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "form_version",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="mapping_versions",
                        to="iaso.formversion",
                    ),
                ),
                (
                    "mapping",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="versions",
                        to="iaso.mapping",
                    ),
                ),
            ],
            options={
                "unique_together": {("form_version", "name")},
            },
        ),
        migrations.CreateModel(
            name="ExportStatus",
            fields=[
                ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                (
                    "status",
                    models.TextField(
                        choices=[
                            ("QUEUED", "Queued"),
                            ("RUNNING", "Running"),
                            ("EXPORTED", "Exported"),
                            ("ERRORED", "Errored"),
                            ("SKIPPED", "Skipped"),
                        ],
                        default="QUEUED",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("export_logs", models.ManyToManyField(blank=True, to="iaso.ExportLog")),
                (
                    "export_request",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.exportrequest"),
                ),
                ("instance", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.instance")),
                (
                    "mapping_version",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.mappingversion"),
                ),
            ],
        ),
        migrations.AddField(
            model_name="instance",
            name="deleted",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="formversion",
            name="form_descriptor",
            field=django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="form",
            name="derived",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="form",
            name="correlatable",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="form",
            name="correlation_field",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="instance",
            name="correlation_id",
            field=models.BigIntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="project",
            name="needs_authentication",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="orgunit",
            name="creator",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
            ),
        ),
        migrations.CreateModel(
            name="Profile",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("account", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.account")),
                (
                    "user",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="iaso_profile",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                ("org_units", models.ManyToManyField(blank=True, related_name="iaso_profile", to="iaso.OrgUnit")),
            ],
        ),
        migrations.AlterField(
            model_name="instance",
            name="location",
            field=django.contrib.gis.db.models.fields.PointField(blank=True, dim=3, null=True, srid=4326),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="location",
            field=django.contrib.gis.db.models.fields.PointField(blank=True, dim=3, null=True, srid=4326),
        ),
        migrations.CreateModel(
            name="FeatureFlag",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("code", models.CharField(max_length=30)),
                ("name", models.CharField(max_length=100)),
                ("description", models.TextField(blank=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.AddField(
            model_name="project",
            name="feature_flags",
            field=models.ManyToManyField(blank=True, related_name="_project_feature_flags_+", to="iaso.FeatureFlag"),
        ),
        migrations.CreateModel(
            name="GroupSet",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("source_ref", models.TextField(blank=True, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("groups", models.ManyToManyField(blank=True, related_name="group_sets", to="iaso.Group")),
                (
                    "source_version",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="iaso.sourceversion"
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="BulkOperation",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("operation_type", models.CharField(choices=[("UPDATE", "Update")], max_length=100)),
                ("operation_count", models.PositiveIntegerField()),
                ("json_body", django.contrib.postgres.fields.jsonb.JSONField()),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "content_type",
                    models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to="contenttypes.contenttype"),
                ),
                ("user", models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                "db_table": "iaso_operation_bulkupdate",
            },
        ),
        migrations.CreateModel(
            name="DevicePosition",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("uuid", models.UUIDField(default=uuid.uuid4, unique=True)),
                ("location", django.contrib.gis.db.models.fields.PointField(dim=3, srid=4326)),
                ("accuracy", models.DecimalField(decimal_places=2, max_digits=7)),
                ("captured_at", models.DateTimeField()),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("device", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.device")),
            ],
        ),
        # migrations.RunPython(
        #     code=iaso.migrations.0052_fix_period_before_after.fix_period_before_after,
        #     reverse_code=django.db.migrations.operations.special.RunPython.noop,
        # ),
        migrations.AlterField(
            model_name="mapping",
            name="mapping_type",
            field=models.TextField(
                choices=[
                    ("AGGREGATE", "Aggregate"),
                    ("EVENT", "Event"),
                    ("EVENT_TRACKER", "Event Tracker"),
                    ("DERIVED", "Derived"),
                ]
            ),
        ),
        migrations.AddField(
            model_name="exportstatus",
            name="last_error_message",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="orgunittype",
            name="projects",
            field=models.ManyToManyField(related_name="unit_types", to="iaso.Project"),
        ),
        migrations.AddField(
            model_name="orgunit",
            name="path",
            field=django_ltree.fields.PathField(blank=True, null=True, unique=True),
        ),
        migrations.AddIndex(
            model_name="orgunit",
            index=django.contrib.postgres.indexes.GistIndex(
                buffering=True, fields=["path"], name="iaso_orguni_path_d11c66_gist"
            ),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="geom",
            field=django.contrib.gis.db.models.fields.GeometryField(null=True, srid=4326),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="simplified_geom",
            field=django.contrib.gis.db.models.fields.GeometryField(null=True, srid=4326),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="catchment",
            field=django.contrib.gis.db.models.fields.GeometryField(null=True, srid=4326),
        ),
        migrations.RunSQL(
            sql="update iaso_orgunit set geom=st_multi(geom) where geom is not null",
            reverse_sql="",
        ),
        migrations.RunSQL(
            sql="update iaso_orgunit set simplified_geom=st_multi(simplified_geom) where simplified_geom is not null",
            reverse_sql="",
        ),
        migrations.RunSQL(
            sql="update iaso_orgunit set catchment=st_multi(catchment) where catchment is not null",
            reverse_sql="",
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="catchment",
            field=django.contrib.gis.db.models.fields.MultiPolygonField(
                blank=True, geography=True, null=True, srid=4326
            ),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="geom",
            field=django.contrib.gis.db.models.fields.MultiPolygonField(
                blank=True, geography=True, null=True, srid=4326
            ),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="location",
            field=django.contrib.gis.db.models.fields.PointField(
                blank=True, dim=3, geography=True, null=True, srid=4326
            ),
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="simplified_geom",
            field=django.contrib.gis.db.models.fields.MultiPolygonField(
                blank=True, geography=True, null=True, srid=4326
            ),
        ),
        migrations.RemoveField(
            model_name="orgunit",
            name="latitude",
        ),
        migrations.RemoveField(
            model_name="orgunit",
            name="longitude",
        ),
        migrations.RemoveField(
            model_name="orgunit",
            name="geom_source",
        ),
        migrations.AlterField(
            model_name="orgunit",
            name="sub_source",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="orgunit",
            name="validation_status",
            field=models.CharField(
                choices=[("NEW", "new"), ("VALID", "valid"), ("REJECTED", "rejected")], default="NEW", max_length=25
            ),
        ),
        # migrations.RunPython(
        #     code=iaso.migrations.0062_transfer_validation_status.transfer_validation_status,
        # ),
        migrations.AddField(
            model_name="form",
            name="uuid",
            field=models.UUIDField(blank=True, null=True),
        ),
        # migrations.RunPython(
        #     code=iaso.migrations.0063_form_uuid.create_uuid,
        # ),
        migrations.AlterField(
            model_name="form",
            name="uuid",
            field=models.UUIDField(unique=True),
        ),
        migrations.AddField(
            model_name="instancefile",
            name="deleted",
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name="form",
            name="uuid",
            field=models.UUIDField(default=uuid.uuid4, unique=True),
        ),
        migrations.AlterField(
            model_name="featureflag",
            name="code",
            field=models.CharField(max_length=30, unique=True),
        ),
        migrations.AlterField(
            model_name="project",
            name="name",
            field=models.TextField(),
        ),
        migrations.AlterField(
            model_name="datasource",
            name="read_only",
            field=models.BooleanField(default=False),
        ),
        # migrations.RunPython(
        #     code=iaso.migrations.0065_auto_20201201_1228.set_all_writeable,
        # ),
        migrations.AlterField(
            model_name="deviceownership",
            name="end",
            field=models.DateTimeField(null=True),
        ),
        migrations.AlterField(
            model_name="device",
            name="imei",
            field=models.CharField(blank=True, max_length=250, null=True),
        ),
        migrations.AddField(
            model_name="deviceposition",
            name="transport",
            field=models.CharField(
                choices=[("car", "Car"), ("foot", "Foot"), ("truck", "Truc")], default="car", max_length=32
            ),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="exportrequest",
            name="status",
            field=models.TextField(
                choices=[
                    ("QUEUED", "Queued"),
                    ("RUNNING", "Running"),
                    ("EXPORTED", "Exported"),
                    ("ERRORED", "Errored"),
                    ("SKIPPED", "Skipped"),
                    ("SUCCESS", "Success"),
                ],
                default="QUEUED",
            ),
        ),
        migrations.AlterField(
            model_name="exportstatus",
            name="status",
            field=models.TextField(
                choices=[
                    ("QUEUED", "Queued"),
                    ("RUNNING", "Running"),
                    ("EXPORTED", "Exported"),
                    ("ERRORED", "Errored"),
                    ("SKIPPED", "Skipped"),
                    ("SUCCESS", "Success"),
                ],
                default="QUEUED",
            ),
        ),
        migrations.AlterField(
            model_name="exportrequest",
            name="status",
            field=models.TextField(
                choices=[
                    ("QUEUED", "Queued"),
                    ("RUNNING", "Running"),
                    ("EXPORTED", "Exported"),
                    ("ERRORED", "Errored"),
                    ("SKIPPED", "Skipped"),
                    ("KILLED", "Killed"),
                    ("SUCCESS", "Success"),
                ],
                default="QUEUED",
            ),
        ),
        migrations.AlterField(
            model_name="exportstatus",
            name="status",
            field=models.TextField(
                choices=[
                    ("QUEUED", "Queued"),
                    ("RUNNING", "Running"),
                    ("EXPORTED", "Exported"),
                    ("ERRORED", "Errored"),
                    ("SKIPPED", "Skipped"),
                    ("KILLED", "Killed"),
                    ("SUCCESS", "Success"),
                ],
                default="QUEUED",
            ),
        ),
        migrations.CreateModel(
            name="Task",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("ended_at", models.DateTimeField(blank=True, null=True)),
                ("progress_value", models.IntegerField(default=0)),
                ("end_value", models.IntegerField(default=0)),
                ("result", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("account", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.account")),
                (
                    "launcher",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("name", models.TextField(default="task")),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("QUEUED", "Queued"),
                            ("RUNNING", "Running"),
                            ("EXPORTED", "Exported"),
                            ("ERRORED", "Errored"),
                            ("SKIPPED", "Skipped"),
                            ("KILLED", "Killed"),
                            ("SUCCESS", "Success"),
                        ],
                        default="QUEUED",
                        max_length=40,
                    ),
                ),
                ("params", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("started_at", models.DateTimeField(blank=True, null=True)),
                ("queue_answer", django.contrib.postgres.fields.jsonb.JSONField(blank=True, null=True)),
                ("progress_message", models.TextField(blank=True, null=True)),
                ("should_be_killed", models.BooleanField(default=False)),
            ],
        ),
        migrations.AddField(
            model_name="form",
            name="label_keys",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=django.contrib.postgres.fields.citext.CITextField(blank=True, max_length=255),
                blank=True,
                null=True,
                size=100,
            ),
        ),
        migrations.AddField(
            model_name="project",
            name="external_token",
            field=models.UUIDField(default=uuid.uuid4, null=True),
        ),
        migrations.AddField(
            model_name="profile",
            name="external_user_id",
            field=models.CharField(blank=True, max_length=512, null=True),
        ),
        migrations.AddField(
            model_name="instance",
            name="to_export",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="exportrequest",
            name="continue_on_error",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="datasource",
            name="default_version",
            field=models.ForeignKey(
                blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to="iaso.sourceversion"
            ),
        ),
        migrations.AddField(
            model_name="form",
            name="deleted_at",
            field=models.DateTimeField(blank=True, default=None, null=True),
        ),
        migrations.AddField(
            model_name="formversion",
            name="end_period",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="formversion",
            name="start_period",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.DeleteModel(
            name="BulkOperation",
        ),
        migrations.RunSQL(
            sql="\nCREATE OR REPLACE FUNCTION iaso_group_org_units_same_source_version() RETURNS trigger AS\n$F$\nBEGIN\n    IF ((select count(*) from iaso_group_org_units go\n            join iaso_group on (iaso_group.id = go.group_id)\n            join iaso_orgunit on (iaso_orgunit.id = go.orgunit_id)\n            where go.group_id = new.group_id\n            and go.orgunit_id = new.orgunit_id\n            and iaso_orgunit.version_id != iaso_group.source_version_id) > 0)\n    THEN\n        RAISE EXCEPTION 'Constraint violation iaso_group_org_units_same_source_version_constraint';\n    END IF;\n    RETURN NEW;\nEND;\n$F$ LANGUAGE plpgsql;",
            reverse_sql="DROP FUNCTION iaso_group_org_units_same_source_version;",
        ),
        migrations.RunSQL(
            sql="\n        CREATE CONSTRAINT TRIGGER iaso_group_org_units_same_source_version_constraint\n        AFTER INSERT OR UPDATE\n        ON iaso_group_org_units\n        DEFERRABLE INITIALLY DEFERRED\n        FOR EACH ROW\n        EXECUTE PROCEDURE iaso_group_org_units_same_source_version();\n        ",
            reverse_sql="\n        DROP TRIGGER iaso_group_org_units_same_source_version_constraint\n        ON iaso_group_org_units;",
        ),
        migrations.RunSQL(
            sql="\n    CREATE OR REPLACE FUNCTION iaso_group_org_units_same_source_version_group() RETURNS trigger AS\n    $F$\n    BEGIN\n        IF ((select count(*) from iaso_group_org_units go\n                join iaso_group on (iaso_group.id = go.group_id)\n                join iaso_orgunit on (iaso_orgunit.id = go.orgunit_id)\n                where go.group_id = new.id\n\n                and iaso_orgunit.version_id != iaso_group.source_version_id) > 0)\n        THEN\n            RAISE EXCEPTION 'Constraint violation iaso_group_org_units_same_source_version_constraint';\n        END IF;\n        RETURN NEW;\n    END;\n    $F$ LANGUAGE plpgsql;",
            reverse_sql="DROP FUNCTION iaso_group_org_units_same_source_version;",
        ),
        migrations.RunSQL(
            sql="\n            CREATE CONSTRAINT TRIGGER iaso_group_same_source_version_as_org_unit_constraint\n            AFTER INSERT OR UPDATE\n            ON iaso_group\n            DEFERRABLE INITIALLY DEFERRED\n            FOR EACH ROW\n            EXECUTE PROCEDURE iaso_group_org_units_same_source_version_group();",
            reverse_sql="\n            DROP TRIGGER iaso_group_same_source_version_as_org_unit_constraint\n            ON iaso_group;",
        ),
        migrations.RunSQL(
            sql="\n    CREATE OR REPLACE FUNCTION iaso_group_org_units_same_source_version_orgunit() RETURNS trigger AS\n    $F$\n    BEGIN\n        IF ((select count(*) from iaso_group_org_units go\n                join iaso_group on (iaso_group.id = go.group_id)\n                join iaso_orgunit on (iaso_orgunit.id = go.orgunit_id)\n                where go.orgunit_id = new.id\n                and iaso_orgunit.version_id != iaso_group.source_version_id) > 0)\n        THEN\n            RAISE EXCEPTION 'Constraint violation iaso_group_org_units_same_source_version_constraint';\n        END IF;\n        RETURN NEW;\n    END;\n    $F$ LANGUAGE plpgsql;",
            reverse_sql="DROP FUNCTION iaso_group_org_units_same_source_version_orgunit;",
        ),
        migrations.RunSQL(
            sql="\n            CREATE CONSTRAINT TRIGGER iaso_org_units_same_source_version_constraint\n            AFTER INSERT OR UPDATE\n            ON iaso_orgunit\n            DEFERRABLE INITIALLY DEFERRED\n            FOR EACH ROW\n            EXECUTE PROCEDURE iaso_group_org_units_same_source_version_orgunit();\n            ",
            reverse_sql="\n            DROP TRIGGER iaso_org_units_same_source_version_constraint ON iaso_orgunit;",
        ),
        migrations.AddField(
            model_name="group",
            name="domain",
            field=models.CharField(blank=True, choices=[("POLIO", "Polio")], max_length=10, null=True),
        ),
        migrations.CreateModel(
            name="Page",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.TextField()),
                ("content", models.TextField(blank=True, null=True)),
                ("slug", models.SlugField(max_length=1000, unique=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("users", models.ManyToManyField(blank=True, related_name="pages", to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.AddField(
            model_name="profile",
            name="language",
            field=models.CharField(blank=True, max_length=512, null=True),
        ),
        migrations.AlterField(
            model_name="algorithmrun",
            name="result",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="exportlog",
            name="received",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="exportlog",
            name="sent",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="exportrequest",
            name="params",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="exportrequest",
            name="result",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="form",
            name="fields",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="formversion",
            name="form_descriptor",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="instance",
            name="json",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="mappingversion",
            name="json",
            field=models.JSONField(),
        ),
        migrations.AlterField(
            model_name="task",
            name="params",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="task",
            name="queue_answer",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="task",
            name="result",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.CreateModel(
            name="ImportGPKG",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("file", models.FileField(upload_to="gpkg_import/")),
                ("version_number", models.IntegerField()),
                ("data_source", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.datasource")),
                ("project", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="iaso.project")),
            ],
        ),
        migrations.CreateModel(
            name="CommentIaso",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("object_pk", models.CharField(db_index=True, max_length=64, verbose_name="object ID")),
                ("user_name", models.CharField(blank=True, max_length=50, verbose_name="user's name")),
                ("user_email", models.EmailField(blank=True, max_length=254, verbose_name="user's email address")),
                ("user_url", models.URLField(blank=True, verbose_name="user's URL")),
                ("comment", models.TextField(max_length=3000, verbose_name="comment")),
                ("submit_date", models.DateTimeField(db_index=True, default=None, verbose_name="date/time submitted")),
                (
                    "ip_address",
                    models.GenericIPAddressField(blank=True, null=True, unpack_ipv4=True, verbose_name="IP address"),
                ),
                (
                    "is_public",
                    models.BooleanField(
                        default=True,
                        help_text="Uncheck this box to make the comment effectively disappear from the site.",
                        verbose_name="is public",
                    ),
                ),
                (
                    "is_removed",
                    models.BooleanField(
                        db_index=True,
                        default=False,
                        help_text='Check this box if the comment is inappropriate. A "This comment has been removed" message will be displayed instead.',
                        verbose_name="is removed",
                    ),
                ),
                (
                    "content_type",
                    models.ForeignKey(
                        limit_choices_to={"model": "orgunit"},
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="content_type_set_for_commentiaso2",
                        to="contenttypes.contenttype",
                        verbose_name="content type",
                    ),
                ),
                (
                    "parent",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="children",
                        to="iaso.commentiaso",
                    ),
                ),
                ("site", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="sites.site")),
                (
                    "user",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="commentiaso_comments",
                        to=settings.AUTH_USER_MODEL,
                        verbose_name="user",
                    ),
                ),
            ],
            options={
                "verbose_name": "comment",
                "verbose_name_plural": "comments",
                "ordering": ("submit_date",),
                "permissions": [("can_moderate", "Can moderate comments")],
                "abstract": False,
            },
        ),
        migrations.CreateModel(
            name="AccountFeatureFlag",
            fields=[
                ("name", models.CharField(max_length=255)),
                ("code", models.CharField(max_length=255, primary_key=True, serialize=False)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.AddField(
            model_name="account",
            name="feature_flags",
            field=models.ManyToManyField(to="iaso.AccountFeatureFlag"),
        ),
        migrations.RunPython(
            code=create_shape_account_flag,
            reverse_code=reverse_create_shape_account_flag,
        ),
        migrations.RunPython(
            code=create_catchment_account_flag,
            reverse_code=reverse_catchment_shape_account_flag,
        ),
        migrations.AddField(
            model_name="orgunittype",
            name="category",
            field=models.CharField(
                blank=True, choices=[("COUNTRY", "Country"), ("DISTRICT", "District")], max_length=8, null=True
            ),
        ),
        migrations.AlterModelOptions(
            name="task",
            options={"ordering": ["-created_at"]},
        ),
    ]
