
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="assets/iaso-favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.1">
    
    
      
        <title>How Iaso is deployed on AWS - IASO</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.402914a4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-iaso-is-deployed-on-aws" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="IASO" class="md-header__button md-logo" aria-label="IASO" data-md-component="logo">
      
  <img src="assets/iaso.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IASO
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How Iaso is deployed on AWS
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="AWS-Deployment.html" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
              
                <li class="md-select__item">
                  <a href="fr/AWS-Deployment.html" hreflang="fr" class="md-select__link">
                    Français
                  </a>
                </li>
              
                <li class="md-select__item">
                  <a href="es/AWS-Deployment.html" hreflang="es" class="md-select__link">
                    Español
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/BLSQ/iaso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
<!-- Navigation -->


<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
    <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
            


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="IASO" class="md-nav__button md-logo" aria-label="IASO" data-md-component="logo">
      
  <img src="assets/iaso.png" alt="logo">

    </a>
    IASO
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/BLSQ/iaso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Users
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Users
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/users/reference/iaso_concepts/iaso_concepts.html" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/users/reference/iaso_modules/iaso_modules.html" class="md-nav__link">
        Modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/users/reference/iaso_web/user_guide.html" class="md-nav__link">
        Web Platform
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/users/reference/iaso_mobile/iaso_mobile.html" class="md-nav__link">
        Mobile Application
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
      
      
      
        <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          References
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          References
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/data_model_glossary/data_model_glossary.html" class="md-nav__link">
        Data model glossary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/sql_dashboard/SQL_Dashboard_feature.html" class="md-nav__link">
        SQL Dashboard feature
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/docker/docker.html" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/background_tasks/background_tasks.html" class="md-nav__link">
        Background tasks & worker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/env_variables/env_variables.html" class="md-nav__link">
        Environnement variables
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_1_6" id="__nav_3_1_6_label" tabindex="0">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_1_6">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/reference/API/entity.html" class="md-nav__link">
        API reference: Entity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          How to
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          How to
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/how_to/contribute/contribute.html" class="md-nav__link">
        Contribute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/how_to/setup_dev_env/setup_dev_env.html" class="md-nav__link">
        Setup a dev environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pages/dev/how_to/use_iaso_apis/use_iaso_apis.html" class="md-nav__link">
        Use iaso apis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          More about IASO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          More about IASO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://www.openiaso.com/" class="md-nav__link">
        IASO website
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://www.digitalpublicgoods.net/r/iaso" class="md-nav__link">
        Digital Public Goods Registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/BLSQ/iaso/releases" class="md-nav__link">
        Release notes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://www.bluesquarehub.com/" class="md-nav__link">
        Bluesquare website
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
            <!-- pdf download  -->
            <div id="pdf-download-container">
                <button id="pdf-download" type="button">
                    <span id="button-text">Download current page</span>
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#192041">
                        <path
                            d="M360-460h40v-80h40q17 0 28.5-11.5T480-580v-40q0-17-11.5-28.5T440-660h-80v200Zm40-120v-40h40v40h-40Zm120 120h80q17 0 28.5-11.5T640-500v-120q0-17-11.5-28.5T600-660h-80v200Zm40-40v-120h40v120h-40Zm120 40h40v-80h40v-40h-40v-40h40v-40h-80v200ZM320-240q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Table of contents -->


<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
    <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#main-parts" class="md-nav__link">
    Main parts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-infrastructure" class="md-nav__link">
    Host infrastructure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-of-the-elastic-beainstalk" class="md-nav__link">
    Setup of the Elastic Beainstalk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-django-3-on-elastic-beanstalk-custom-ami" class="md-nav__link">
    Running Django 3 on Elastic Beanstalk / Custom AMI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-is-the-code" class="md-nav__link">
    Where is the code ?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-services" class="md-nav__link">
    Related services
  </a>
  
</li>
      
    </ul>
  
</nav>
        </div>
    </div>
</div>



          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/BLSQ/iaso/edit/main/docs/AWS-Deployment.en.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<h1 id="how-iaso-is-deployed-on-aws">How Iaso is deployed on AWS<a class="headerlink" href="#how-iaso-is-deployed-on-aws" title="Permanent link">#</a></h1>
<p>on ElasticBeanstalk + RDS
<img alt="schema archi iaso.svg" src="schema%20archi%20iaso.svg" /></p>
<hr />
<h2 id="main-parts">Main parts<a class="headerlink" href="#main-parts" title="Permanent link">#</a></h2>
<ul>
<li>Creation of the HOST environment where the Iaso code will be deployed as well as the related services</li>
<li>The deployment of the code itself and of new version</li>
</ul>
<hr />
<h2 id="host-infrastructure">Host infrastructure<a class="headerlink" href="#host-infrastructure" title="Permanent link">#</a></h2>
<p>This documentation concerned the main Iaso deployment, that are done on AWS.</p>
<p>The main pillar is <em>AWS  Elastic beanstalk</em></p>
<p>Which is kind of a magic solution from Amazon that tie several of their service together, handle deployment logic, etc...</p>
<p>In the past we configured it by hands but now we are moving toward having it  all handled via Terrraform so it is in code (we can have an history, avoid misclick, do complex ops etc...).</p>
<p>The technical term for this is "Provisioning" if you want to look it up.</p>
<h2 id="setup-of-the-elastic-beainstalk">Setup of the Elastic Beainstalk<a class="headerlink" href="#setup-of-the-elastic-beainstalk" title="Permanent link">#</a></h2>
<p>See<br />
https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create-deploy-python-django.html</p>
<p>We have custom commands and configuration in <a href=".ebextensions/">.ebextensions/</a> and in 
and in <a href=".platform/">.platform/</a> to extend the nginx config.</p>
<h2 id="running-django-3-on-elastic-beanstalk-custom-ami">Running Django 3 on Elastic Beanstalk / Custom AMI<a class="headerlink" href="#running-django-3-on-elastic-beanstalk-custom-ami" title="Permanent link">#</a></h2>
<p>Django 3 requires version 2+ of the gdal library. Sadly, Beanstalk is
based on Amazon Linux that contain an outdated version of GDAL.</p>
<p>To fix this you have to create  a custom AMI to use in your Elastic Beanstalk
environments and compile and your own version of gdal and it's dependencies.</p>
<p>See the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.customenv.html">AWS documentation on creating adn using a custom AMI</a>
and the <a href="https://docs.djangoproject.com/en/4.1/ref/contrib/gis/install/">Django documentation on compiling the GIS libraries</a></p>
<p>Custom build of the following libraries were done:</p>
<ul>
<li>geos</li>
<li>SQLite</li>
<li>proj</li>
<li>proj-data</li>
<li>spatialite</li>
<li>gdal</li>
</ul>
<p>You can check <code>scripts/create_ami.sh</code> for reference</p>
<p>Read <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.customenv.html">AWS documentation on creating adn using a custom AMI</a>
but in summary:</p>
<ol>
<li>In EC2 -&gt; AMIs, identify the AMI of the Elastic Beanstalk EC2 server(Ex: Choose a public AMI in which python3.9 installed with Amazon Linux 2).</li>
<li>Select the AMI and launch a new instance based on it. </li>
<li>Specify the instance name and choose a key pair.</li>
<li>Don't forget to set in the advanced section:</li>
</ol>
<pre><code class="language-yaml">#cloud-config
  repo_releasever: repository version number
  repo_upgrade: none
</code></pre>
<ol>
<li>Connect via SSH to the instance</li>
<li>Install the dependencies (see scripts/create_ami.sh)</li>
<li>Then go to Actions -&gt; Image -&gt; Create Image</li>
<li>When it's ready, go to the Beanstalk Instance Settings and specify the AMI reference of the image we just created.</li>
</ol>
<hr />
<h2 id="where-is-the-code">Where is the code ?<a class="headerlink" href="#where-is-the-code" title="Permanent link">#</a></h2>
<p>Infrastructure and configuration in the Github repository
<a href="https://github.com/BLSQ/terraform-iaso-eb">BLSQ/terraform-iaso-eb</a> There is good documentation from Mbayang in the <code>docs/</code> folder. Visibility is restricted.</p>
<p>In the <code>BLSQ/iaso</code> Github repository:
* <code>.github</code> For the workflow info
* <code>scripts/</code>
* <code>.ebextension</code> For the Elastic beanstalk specific command
* <code>.platform</code> Configuration override</p>
<hr />
<h2 id="related-services">Related services<a class="headerlink" href="#related-services" title="Permanent link">#</a></h2>
<ul>
<li>S3 bucket: For the static and the user uploaded media (in AWS)</li>
<li>Enketo (in another AWS Elastic Beanstalk)</li>
<li>Postgresql RDS (in AWS)</li>
<li>Queue Service for background Worker  (in AWS SQS)</li>
<li>Sentry: error handling and notification (as Saas)</li>
<li>MailGun (as Saas)</li>
<li>Route53: DNS redirection (in AWS)</li>
</ul>
<hr />
<p>Two type of env in elastic beanstalk:
* web
* worker</p>
<p>We tie them via an "env" tag in AWS, so we can deploy them at the same time</p>
<p>One Elastic Beanstalk Env can contain multipe "EC2 Instance", that is virtual machine server.  Their number auto scale according to rule in elastic beanstalk.
Usually we have 1 instance for Worker and 2 for Web.</p>
<hr />
<h1 id="s3-bucket">S3 bucket<a class="headerlink" href="#s3-bucket" title="Permanent link">#</a></h1>
<ul>
<li>Static: Push static in them so they can be properly cached and CDN (not sure we actually do this)</li>
<li>Media: Store uploaded media by the users : Form response (XML), media attached to Form response (photos), gpkg, form definition, etc.. </li>
</ul>
<p>Static are readable by all.</p>
<p>Media are only accessible via Signed url that expire after a laps of time (15 minutes I think) and that are generated on the fly by iaso when needed.</p>
<hr />
<h1 id="cicd">CI/CD<a class="headerlink" href="#cicd" title="Permanent link">#</a></h1>
<p>Deployment of new version is done via Github action.</p>
<p>Each change on main are automically deployed on the staging environment</p>
<p>Deployment to other env have to be manually triggered</p>
<hr />
<h3 id="deployement-process">Deployement process<a class="headerlink" href="#deployement-process" title="Permanent link">#</a></h3>
<p>How a new version of Iaso is deployed</p>
<p>This is a simplified view, some details are omitted for clarity</p>
<ol>
<li>A user trigger the deploy worflow in github actions (or it is trigger automatically for staging)</li>
<li>In the github worker: (code in .github/workflows/deploy.yml)<ol>
<li>Determine version number. Call set_version to set it.</li>
<li>It build all the JS/CSS and other ressource for the front-end</li>
<li>Add the to the git repo</li>
<li>scripts/eb-deploy.py:<ol>
<li>Connect to the AWS api to fetch all the <em>beanstalk environments</em> for the <code>iaso</code> environment. e.g. : <code>staging</code> -&gt; <code>iaso-staging2</code> and <code>iaso-staging2-worker</code></li>
<li>For each beanstalk env, trigger <code>eb deploy</code> (from awseb cli):<ol>
<li>Make a zip file of the content of the git repo (done by eb deploy). Including the compiled asset</li>
<li>Call ElasticBeanstalk API to deploy it</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>In the Iaso servers (EC2 instances): Our code/config for this is in the directory <code>.ebextensions</code> Action markqe with ¥ are part of Elastic beanstalk logic<ol>
<li>Deployment is triggered ¥</li>
<li>New app version is copied in <code>/var/app/staging</code> ¥</li>
<li>The dependencies in requirements.txt are installed  ¥</li>
<li><a href="https://github.com/BLSQ/iaso/blob/main/.ebextensions/50_container_commands.config">Our logic</a> is executed<ol>
<li>Server translations are compiled</li>
<li><strong>The frontend (compiled JS, image, css) is pushed to the S3 bucket.</strong></li>
<li><strong>Database migration are done</strong></li>
<li>Cache table is created</li>
</ol>
</li>
<li><code>/var/app/staging</code> is moved in <code>/var/app/current</code> ¥</li>
<li>If these steps fail, Elastic beanstalk will do a <em>rollback</em> and revert to the previous version. Note since we do manually the maching between worker and web, sometime we have the problem that one is rolled back and not the other and we have a version mismatch. We sometime also have the problem with incompatible database migrations. ¥</li>
<li>Send a Slack notification to notify of the success of failure of the github deployment.</li>
</ol>
</li>
</ol>
<hr />
<h1 id="related-services-in-more-details">Related services in more details<a class="headerlink" href="#related-services-in-more-details" title="Permanent link">#</a></h1>
<ul>
<li>S3 bucket: For the static and the user uploaded media (in AWS)</li>
<li>Enketo (in another AWS Elastic Beanstalk)</li>
<li>Postgresql RDS (in AWS)</li>
<li>Queue Service for background Worker  (in AWS SQS)</li>
<li>Sentry: error handling and notification (as Saas)</li>
<li>MailGun (as Saas)</li>
<li>Route53: DNS redirection (in AWS)</li>
</ul>
<hr />
<h3 id="enketo">Enketo<a class="headerlink" href="#enketo" title="Permanent link">#</a></h3>
<p>Deployed separately, handled via Elastic Beanstalk also, linked to Iaso via environment variable. Mbayang manage this</p>
<hr />
<h3 id="aws-sqs">AWS SQS<a class="headerlink" href="#aws-sqs" title="Permanent link">#</a></h3>
<p>Queue system used for Worker, see worker section in README</p>
<hr />
<h3 id="s3-bucket_1">S3 bucket<a class="headerlink" href="#s3-bucket_1" title="Permanent link">#</a></h3>
<p>S3 see above</p>
<h1 id="architecture-inside-the-vm">Architecture inside the VM<a class="headerlink" href="#architecture-inside-the-vm" title="Permanent link">#</a></h1>
<p>Code is in the <code>/var/app/current</code></p>
<p>Systemctl launch the web server  as the <code>web</code> unit. This is done via Gunicorn under the web user, gunicorn launch multiple Django server.</p>
<p>There is a NGINX in front of gunicorn.
The above is handled automatically via Iaso</p>
<p>The logs can be listed inside the VM via <code>journalctl -u web</code></p>
<p>We have 2 crons (for now). They can be seen  by using <code>systemctl list-timers</code></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": ["content.action.edit"], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.b78d2936.min.js"></script>
      
        <script src="extrajs/html2pdf.bundle.min.js"></script>
      
        <script src="extrajs/pdfDownload.js"></script>
      
        <script src="https://plausible.io/js/script.js"></script>
      
    
  </body>
</html>