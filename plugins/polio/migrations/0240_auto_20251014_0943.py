# Generated by Django 4.2.25 on 2025-10-14 09:43

from django.db import migrations


DOSES_PER_VIAL = {
    "mOPV2": 20,
    "nOPV2": 50,
    "bOPV": 20,
}


def add_doses_per_vial(apps, schema_editor):
    VaccinePreAlert = apps.get_model("polio", "VaccinePreAlert")
    VaccineArrivalReport = apps.get_model("polio", "VaccineArrivalReport")

    pre_alerts_no_doses = VaccinePreAlert.objects.filter(doses_per_vial__isnull=True).prefetch_related("request_form")
    arrival_reports_no_doses = VaccineArrivalReport.objects.filter(doses_per_vial__isnull=True).prefetch_related(
        "request_form"
    )

    for pre_alert in pre_alerts_no_doses:
        doses_per_vial = DOSES_PER_VIAL.get(pre_alert.request_form.vaccine_type, 20)
        pre_alert.doses_per_vial = doses_per_vial
        pre_alert.save()

    for arrival_report in arrival_reports_no_doses:
        doses_per_vial = DOSES_PER_VIAL.get(arrival_report.request_form.vaccine_type, 20)
        arrival_report.doses_per_vial = doses_per_vial
        arrival_report.save()


class Migration(migrations.Migration):
    dependencies = [
        ("polio", "0239_alter_poliopermissionsupport_options"),
    ]

    operations = [migrations.RunPython(add_doses_per_vial, migrations.RunPython.noop)]
